<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C…ôdv…ôl / POS Proqramƒ±</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0b1628;
      --text:#e8eefc;
      --muted:#9db0d0;
      --line:#1f3158;
      --accent:#6ea8ff;
      --accent2:#79ffd7;
      --danger:#ff6b6b;
      --ok:#7CFF8A;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(110,168,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(121,255,215,.12), transparent 60%),
                  linear-gradient(180deg, #070c16, var(--bg));
      min-height:100vh;
    }
    .app{ max-width:1300px; margin:20px auto; padding:16px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position:sticky; top:14px; z-index:20;
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background:
        radial-gradient(10px 10px at 30% 30%, rgba(255,255,255,.65), transparent 60%),
        linear-gradient(135deg, rgba(110,168,255,.95), rgba(121,255,215,.95));
      box-shadow: 0 10px 25px rgba(110,168,255,.25);
    }
    .brand h1{ margin:0; font-size:14px; letter-spacing:.3px; font-weight:800; }
    .brand small{ color:var(--muted); display:block; margin-top:2px; font-weight:500; }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end; }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      transition: .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(110,168,255,.6) }
    .btn:active{ transform: translateY(0px); opacity:.9 }
    .btn.primary{ border-color: rgba(110,168,255,.6); background: rgba(110,168,255,.13); }
    .btn.ok{ border-color: rgba(124,255,138,.6); background: rgba(124,255,138,.10); }
    .btn.danger{ border-color: rgba(255,107,107,.6); background: rgba(255,107,107,.12); }
    .btn.ghost{ background: transparent; }
    .pill{
      font-family:var(--mono);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:14px;
      align-items:start;
    }

    .panel{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 540px;
    }
    .panelHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .panelHead strong{ font-size:13px; }
    .panelBody{ padding:14px; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .grid1{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (max-width: 980px){
      .layout{ grid-template-columns:1fr; }
    }

    .field{
      display:flex; flex-direction:column; gap:6px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
    }
    .field label{ font-size:12px; color:var(--muted); }
    .input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:12px;
      font-family: var(--mono);
    }
    textarea{ min-height:84px; resize:vertical; font-family: var(--sans); }
    .input:focus, select:focus, textarea:focus{
      border-color: rgba(110,168,255,.6);
      box-shadow: 0 0 0 4px rgba(110,168,255,.12);
    }

    .tableWrap{
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      overflow:auto;
      background: rgba(0,0,0,.12);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size:12px;
    }
    th, td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:10px 10px;
      text-align:left;
      vertical-align:top;
    }
    th{
      position:sticky; top:0; z-index:2;
      background: rgba(0,0,0,.25);
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    td small{ color:var(--muted); display:block; margin-top:4px; }
    .rowActions{ display:flex; flex-wrap:wrap; gap:8px; }
    .tag{
      display:inline-flex;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:11px;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }

    /* Right sidebar */
    .sidebar{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:sticky;
      top:86px;
    }
    .sideHead{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sideHead strong{ font-size:13px; }
    .sideBody{ padding:10px; display:flex; flex-direction:column; gap:8px; }

    .navGroup{
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,.14);
    }
    .navTitle{
      padding:10px 10px;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
      user-select:none;
      color:var(--text);
      font-weight:800;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .navTitle span{ color:var(--muted); font-weight:700; }
    .navItems{ padding:8px; display:flex; flex-direction:column; gap:8px; }
    .navBtn{
      width:100%;
      text-align:left;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      display:flex; align-items:center; justify-content:space-between;
    }
    .navBtn:hover{ border-color: rgba(110,168,255,.55); }
    .navBtn.active{
      border-color: rgba(121,255,215,.65);
      box-shadow: 0 0 0 4px rgba(121,255,215,.12);
      background: rgba(121,255,215,.08);
    }

    .mini{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .toggleWrap{
      display:flex; align-items:center; gap:10px;
    }
    .sidebar.hidden{ display:none; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:12px;
      color:var(--text);
      font-size:12px;
      box-shadow: var(--shadow);
      display:none;
      z-index:99;
      max-width: 92vw;
    }

    /* Receipt (print) */
    .receipt{
      font-family: var(--mono);
      color:#111;
    }
    .receipt h2{ margin:0 0 8px 0; font-size:18px; }
    .receipt .muted{ color:#444; font-size:12px; }
    .receipt table{ border-collapse:collapse; width:100%; font-size:12px; }
    .receipt th, .receipt td{ border-bottom:1px solid #ddd; padding:8px; text-align:left; }
    .receipt .sum{ margin-top:10px; border-top:2px solid #111; padding-top:10px; }
    .receipt .sum div{ display:flex; justify-content:space-between; padding:3px 0; }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>POS / C…ôdv…ôl Proqramƒ±</h1>
          <small>Reklam saytlar ‚Ä¢ M…ôhsullar ‚Ä¢ Satƒ±≈ü kassa (offline, localStorage)</small>
        </div>
      </div>

      <div class="actions">
        <span class="pill" id="statusPill">Hazƒ±r ‚úÖ</span>
        <div class="toggleWrap">
          <button class="btn ghost" id="toggleSideBtn">‚û°Ô∏è Menyu</button>
          <button class="btn danger" id="wipeAllBtn" title="B√ºt√ºn datanƒ± sil">üß® Reset</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="panel">
        <div class="panelHead">
          <strong id="viewTitle">Satƒ±≈ü Kassa</strong>
          <div class="rowActions">
            <button class="btn" id="exportDataBtn" title="B√ºt√ºn datanƒ± JSON kimi √ßƒ±xart">üíæ Export JSON</button>
            <button class="btn" id="importDataBtn">üì• Import JSON</button>
            <input id="importFile" type="file" accept="application/json" hidden>
          </div>
        </div>
        <div class="panelBody" id="viewHost">
          <!-- views render here -->
        </div>
      </div>

      <div class="sidebar" id="sidebar">
        <div class="sideHead">
          <strong>Saƒü Menyu</strong>
          <button class="btn" id="hideSideBtn">Gizl…ôt</button>
        </div>

        <div class="sideBody">
          <div class="navGroup" data-open="1">
            <div class="navTitle">
              <div>üì£ Reklam saytlar</div>
              <span>idar…ô</span>
            </div>
            <div class="navItems">
              <button class="navBtn" data-view="ads_list">Axtar / Redakt…ô / Sil <span>‚Üí</span></button>
              <button class="navBtn" data-view="ads_new">Yeni reklam sayt <span>Ôºã</span></button>
            </div>
          </div>

          <div class="navGroup" data-open="1">
            <div class="navTitle">
              <div>üßæ Satƒ±≈ü kassa</div>
              <span>POS</span>
            </div>
            <div class="navItems">
              <button class="navBtn active" data-view="pos">Kassa <span>‚úÖ</span></button>
            </div>
          </div>

          <div class="navGroup" data-open="1">
            <div class="navTitle">
              <div>üì¶ M…ôhsullar</div>
              <span>baza</span>
            </div>
            <div class="navItems">
              <button class="navBtn" data-view="product_new">M…ôhsul …ôlav…ô et <span>Ôºã</span></button>
              <button class="navBtn" data-view="products_list">M…ôhsullar (axtar/filter) <span>‚Üí</span></button>
            </div>
          </div>

          <div class="mini">
            ƒ∞pucu: PDF √º√ß√ºn ‚ÄúPDF‚Äù d√ºym…ôsi print p…ônc…ôr…ôsini a√ßƒ±r. Oradan ‚ÄúSave as PDF‚Äù se√ßirs…ôn.
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    // -------------------- Utils --------------------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function uid(prefix="id"){
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display = "none", 1800);
    }
    function fmtMoney(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return "0.00";
      return x.toFixed(2);
    }
    function clamp(n, a, b){
      n = Number(n);
      if(!Number.isFinite(n)) return a;
      return Math.max(a, Math.min(b, n));
    }
    function nowStr(){
      const d = new Date();
      return d.toLocaleString("az-AZ");
    }

    // Barcode: LEM-12345678910
    function genBarcode(){
      const digits = 11;
      let s = "";
      for(let i=0;i<digits;i++){
        s += Math.floor(Math.random()*10);
      }
      return "LEM-" + s;
    }
    // Search code: 6 digits random (example: 123456)
    function genSearchCode(){
      let s = "";
      for(let i=0;i<6;i++) s += Math.floor(Math.random()*10);
      return s;
    }

    // -------------------- Storage --------------------
    const KEY = "pos_app_v1";

    const defaultState = () => ({
      ads: [],        // {id, name, link, createdAt}
      products: [],   // {id, image, name, barcode, searchCode, quality, duration, qty, price, about, phone, mail, whatsapp, createdAt}
      sales: []       // {id, createdAt, items:[{productId,name,price,count,discountedPrice}], totals:{qty,total,discount,paid,change}}
    });

    let state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        const obj = JSON.parse(raw);
        if(!obj || typeof obj !== "object") return defaultState();
        obj.ads ??= [];
        obj.products ??= [];
        obj.sales ??= [];
        return obj;
      }catch{
        return defaultState();
      }
    }
    function saveState(){
      localStorage.setItem(KEY, JSON.stringify(state));
      $("#statusPill").textContent = "Yadda saxlandƒ± ‚úÖ";
      clearTimeout(saveState._tm);
      saveState._tm = setTimeout(()=> $("#statusPill").textContent = "Hazƒ±r ‚úÖ", 900);
    }

    function wipeAll(){
      if(!confirm("B√úT√úN m…ôlumatlar silinsin? (Reklam saytlar, M…ôhsullar, Satƒ±≈ülar)")) return;
      state = defaultState();
      saveState();
      cartReset();
      go("pos");
      toast("Reset edildi");
    }

    // -------------------- Navigation --------------------
    const titles = {
      pos: "Satƒ±≈ü Kassa",
      ads_list: "Reklam saytlar ‚Ä¢ Axtar / Redakt…ô / Sil",
      ads_new: "Yeni reklam sayt",
      product_new: "M…ôhsul …ôlav…ô et",
      products_list: "M…ôhsullar ‚Ä¢ Axtar / Filter"
    };

    function setActiveNav(view){
      $$(".navBtn").forEach(b => b.classList.toggle("active", b.dataset.view === view));
      $("#viewTitle").textContent = titles[view] || "Panel";
    }

    function go(view){
      setActiveNav(view);
      render(view);
    }

    $$(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=> go(btn.dataset.view));
    });

    // group toggle
    $$(".navTitle").forEach(title=>{
      title.addEventListener("click", ()=>{
        const group = title.closest(".navGroup");
        const items = group.querySelector(".navItems");
        const open = group.getAttribute("data-open") === "1";
        group.setAttribute("data-open", open ? "0" : "1");
        items.style.display = open ? "none" : "flex";
      });
    });

    // sidebar toggles
    function showSidebar(){ $("#sidebar").classList.remove("hidden"); $("#toggleSideBtn").textContent = "‚û°Ô∏è Menyu"; }
    function hideSidebar(){ $("#sidebar").classList.add("hidden"); $("#toggleSideBtn").textContent = "‚¨ÖÔ∏è Menyu"; }
    $("#hideSideBtn").addEventListener("click", hideSidebar);
    $("#toggleSideBtn").addEventListener("click", ()=>{
      const hidden = $("#sidebar").classList.contains("hidden");
      hidden ? showSidebar() : hideSidebar();
    });

    $("#wipeAllBtn").addEventListener("click", wipeAll);

    // -------------------- Export/Import whole DB --------------------
    $("#exportDataBtn").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "pos_data.json";
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Export edildi");
    });

    $("#importDataBtn").addEventListener("click", ()=> $("#importFile").click());
    $("#importFile").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        const text = await f.text();
        const obj = JSON.parse(text);
        if(!obj || typeof obj !== "object") throw new Error("bad");
        obj.ads ??= [];
        obj.products ??= [];
        obj.sales ??= [];
        state = obj;
        saveState();
        cartReset();
        go("pos");
        toast("Import olundu");
      }catch{
        alert("JSON d√ºzg√ºn deyil / oxunmadƒ±.");
      }finally{
        e.target.value = "";
      }
    });

    // -------------------- Ads (Reklam saytlar) --------------------
    function adsAdd({name, link}){
      state.ads.unshift({
        id: uid("ad"),
        name: (name||"").trim(),
        link: (link||"").trim(),
        createdAt: Date.now()
      });
      saveState();
    }
    function adsUpdate(id, patch){
      const x = state.ads.find(a => a.id === id);
      if(!x) return;
      Object.assign(x, patch);
      saveState();
    }
    function adsDelete(id){
      state.ads = state.ads.filter(a => a.id !== id);
      saveState();
    }

    // -------------------- Products (M…ôhsullar) --------------------
    const QUALITY = [
      "Standard with ads (1080p)",
      "Standard (1080p)",
      "Premium (4K + HDR)"
    ];
    const DURATION = ["1ay","3ay","6ay","12ay"];

    function productAdd(p){
      state.products.unshift({
        id: uid("prd"),
        image: (p.image||"").trim(),
        name: (p.name||"").trim(),
        barcode: (p.barcode||"").trim(),
        searchCode: (p.searchCode||"").trim(),
        quality: p.quality || QUALITY[0],
        duration: p.duration || DURATION[0],
        qty: clamp(p.qty, 0, 1000000),
        price: clamp(p.price, 0, 100000000),
        about: (p.about||"").trim(),
        phone: (p.phone||"").trim(),
        mail: (p.mail||"").trim(),
        whatsapp: (p.whatsapp||"").trim(),
        createdAt: Date.now()
      });
      saveState();
    }

    function productUpdate(id, patch){
      const x = state.products.find(p=>p.id===id);
      if(!x) return;
      Object.assign(x, patch);
      if("qty" in patch) x.qty = clamp(x.qty, 0, 1000000);
      if("price" in patch) x.price = clamp(x.price, 0, 100000000);
      saveState();
    }

    function productDelete(id){
      if(!confirm("M…ôhsul silinsin?")) return;
      state.products = state.products.filter(p=>p.id!==id);
      saveState();
    }

    function findProductByAny(query){
      const q = (query||"").trim().toLowerCase();
      if(!q) return [];
      return state.products.filter(p=>{
        const a = (p.name||"").toLowerCase();
        const b = (p.barcode||"").toLowerCase();
        const c = (p.searchCode||"").toLowerCase();
        return a.includes(q) || b.includes(q) || c.includes(q);
      });
    }

    // -------------------- POS Cart --------------------
    let cart = {
      selectedProductId: null,
      selectedCount: 1,
      items: new Map(), // productId -> count
      discount: 0,
      paid: 0
    };

    function cartReset(){
      cart = { selectedProductId:null, selectedCount:1, items:new Map(), discount:0, paid:0 };
    }

    function cartAdd(productId, count){
      const p = state.products.find(x=>x.id===productId);
      if(!p) return toast("M…ôhsul tapƒ±lmadƒ±");
      count = clamp(count, 1, 1000000);

      // stock check
      const existing = cart.items.get(productId) || 0;
      const totalWanted = existing + count;
      if(totalWanted > p.qty){
        return alert(`Stok √ßatmƒ±r. M√∂vcud stok: ${p.qty}\nS…ôb…ôtd…ô olan: ${existing}\nƒ∞st…ôdiyin …ôlav…ô: ${count}`);
      }

      cart.items.set(productId, totalWanted);
      toast("S…ôb…ôt…ô …ôlav…ô edildi");
    }

    function cartRemove(productId){
      cart.items.delete(productId);
    }

    function cartTotals(){
      let totalQty = 0;
      let total = 0;

      for(const [pid, count] of cart.items.entries()){
        const p = state.products.find(x=>x.id===pid);
        if(!p) continue;
        totalQty += count;
        total += (Number(p.price)||0) * count;
      }

      const discount = clamp(cart.discount, 0, 100000000);
      const finalTotal = Math.max(0, total - discount);
      const paid = clamp(cart.paid, 0, 100000000);
      const change = Math.max(0, paid - finalTotal);

      return { totalQty, total, discount, finalTotal, paid, change };
    }

    function cartConfirmAndComplete(){
      const itemsArr = [];
      for(const [pid, count] of cart.items.entries()){
        const p = state.products.find(x=>x.id===pid);
        if(!p) continue;
        itemsArr.push({
          productId: pid,
          name: p.name,
          price: Number(p.price)||0,
          count
        });
      }
      if(itemsArr.length === 0){
        return alert("S…ôb…ôt bo≈üdur.");
      }

      const totals = cartTotals();

      // reduce stock
      for(const it of itemsArr){
        const p = state.products.find(x=>x.id===it.productId);
        if(!p) continue;
        if(it.count > p.qty){
          return alert(`Stok d…ôyi≈üib! "${p.name}" √º√ß√ºn stok √ßatmƒ±r. M√∂vcud: ${p.qty}`);
        }
      }
      for(const it of itemsArr){
        const p = state.products.find(x=>x.id===it.productId);
        if(!p) continue;
        p.qty = clamp(p.qty - it.count, 0, 1000000);
      }

      const sale = {
        id: uid("sale"),
        createdAt: Date.now(),
        items: itemsArr,
        totals: {
          qty: totals.totalQty,
          total: totals.total,
          discount: totals.discount,
          finalTotal: totals.finalTotal,
          paid: totals.paid,
          change: totals.change
        }
      };

      state.sales.unshift(sale);
      saveState();

      // reset cart
      const receiptHtml = renderReceiptHTML(sale);
      cartReset();
      toast("Satƒ±≈ü tamamlandƒ± ‚úÖ");

      // return sale + receipt
      return { sale, receiptHtml };
    }

    function renderReceiptHTML(sale){
      const rows = sale.items.map(it=>{
        const lineTotal = (it.price * it.count);
        return `
          <tr>
            <td>${escapeHtml(it.name)}</td>
            <td>${fmtMoney(it.price)}</td>
            <td>${it.count}</td>
            <td>${fmtMoney(lineTotal)}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="receipt">
          <h2>Satƒ±≈ü Q…ôbzi</h2>
          <div class="muted">Tarix/Saat: ${new Date(sale.createdAt).toLocaleString("az-AZ")}</div>
          <div class="muted">Satƒ±≈ü ID: ${sale.id}</div>
          <br/>
          <table>
            <thead>
              <tr>
                <th>Mehsul adlarƒ±</th>
                <th>Qiym…ôt</th>
                <th>Say</th>
                <th>Toplam</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>

          <div class="sum">
            <div><b>Toplam M…ôhsul sayƒ±</b> <b>${sale.totals.qty}</b></div>
            <div><span>Toplam tutar</span> <b>${fmtMoney(sale.totals.total)}</b></div>
            <div><span>Endirim</span> <b>${fmtMoney(sale.totals.discount)}</b></div>
            <div><span>√ñd…ônil…ôc…ôk</span> <b>${fmtMoney(sale.totals.finalTotal)}</b></div>
            <div><span>Alƒ±nan m…ôbl…ôq</span> <b>${fmtMoney(sale.totals.paid)}</b></div>
            <div><span>Qaytarƒ±lacaq m…ôbl…ôƒü</span> <b>${fmtMoney(sale.totals.change)}</b></div>
          </div>
          <br/>
          <div class="muted">T…ô≈ü…ôkk√ºrl…ôr!</div>
        </div>
      `;
    }

    function openPrintWindow(html, title="Q…ôbz"){
      const w = window.open("", "_blank");
      if(!w) return alert("Pop-up bloklanƒ±b. Brauzerd…ô pop-up icaz…ôsi ver.");
      w.document.open();
      w.document.write(`
        <!doctype html>
        <html>
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>${escapeHtml(title)}</title>
            <style>
              body{ font-family: ui-monospace, Menlo, Consolas, monospace; padding:18px; }
              .receipt{ max-width:700px; margin:0 auto; }
              h2{ margin:0 0 8px 0; }
              .muted{ color:#444; font-size:12px; }
              table{ width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
              th,td{ border-bottom:1px solid #ddd; padding:8px; text-align:left; }
              .sum{ margin-top:10px; border-top:2px solid #111; padding-top:10px; }
              .sum div{ display:flex; justify-content:space-between; padding:3px 0; }
              @media print{
                button{ display:none !important; }
              }
              .bar{ display:flex; gap:10px; justify-content:flex-end; margin:0 0 10px 0; }
              button{ padding:10px 12px; border-radius:10px; border:1px solid #ccc; cursor:pointer; }
            </style>
          </head>
          <body>
            <div class="bar">
              <button onclick="window.print()">√áap et / PDF</button>
              <button onclick="window.close()">Baƒüla</button>
            </div>
            ${html}
          </body>
        </html>
      `);
      w.document.close();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // -------------------- Views --------------------
    function render(view){
      const host = $("#viewHost");
      host.innerHTML = "";
      if(view === "ads_list") host.appendChild(viewAdsList());
      else if(view === "ads_new") host.appendChild(viewAdsNew());
      else if(view === "product_new") host.appendChild(viewProductNew());
      else if(view === "products_list") host.appendChild(viewProductsList());
      else host.appendChild(viewPOS());
    }

    // ---- Ads list (search/edit/delete)
    function viewAdsList(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      const top = document.createElement("div");
      top.className = "grid2";
      top.innerHTML = `
        <div class="field">
          <label>Axtar</label>
          <input class="input" id="adsSearch" placeholder="ad v…ô ya link..." />
        </div>
        <div class="field">
          <label>Tez …ôm…ôl</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="goAdsNew">Ôºã Yeni reklam sayt</button>
          </div>
        </div>
      `;
      wrap.appendChild(top);

      const table = document.createElement("div");
      table.className = "tableWrap";
      table.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Ad</th>
              <th>Link</th>
              <th>Tarix</th>
              <th>∆èm…ôliyyat</th>
            </tr>
          </thead>
          <tbody id="adsTbody"></tbody>
        </table>
      `;
      wrap.appendChild(table);

      $("#viewHost")?.appendChild(wrap);

      wrap.querySelector("#goAdsNew").addEventListener("click", ()=> go("ads_new"));

      function draw(){
        const q = (wrap.querySelector("#adsSearch").value||"").trim().toLowerCase();
        const rows = state.ads.filter(a=>{
          if(!q) return true;
          return (a.name||"").toLowerCase().includes(q) || (a.link||"").toLowerCase().includes(q);
        });

        const tb = wrap.querySelector("#adsTbody");
        tb.innerHTML = rows.map(a=>`
          <tr>
            <td>
              <b>${escapeHtml(a.name||"")}</b>
              <small>ID: ${a.id}</small>
            </td>
            <td>
              <a href="${escapeHtml(a.link||"#")}" target="_blank" rel="noreferrer" style="color: var(--accent2); text-decoration:none;">
                ${escapeHtml(a.link||"")}
              </a>
            </td>
            <td>${new Date(a.createdAt).toLocaleString("az-AZ")}</td>
            <td>
              <div class="rowActions">
                <button class="btn" data-act="edit" data-id="${a.id}">‚úèÔ∏è Redakt…ô</button>
                <button class="btn danger" data-act="del" data-id="${a.id}">üóë Sil</button>
              </div>
            </td>
          </tr>
        `).join("") || `
          <tr><td colspan="4" class="mini" style="padding:14px;">He√ß n…ô tapƒ±lmadƒ±.</td></tr>
        `;

        tb.querySelectorAll("button[data-act]").forEach(btn=>{
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          btn.addEventListener("click", ()=>{
            if(act === "del"){
              if(!confirm("Reklam saytƒ± silinsin?")) return;
              adsDelete(id);
              draw();
              toast("Silindi");
            }else if(act === "edit"){
              const a = state.ads.find(x=>x.id===id);
              if(!a) return;
              const name = prompt("Ad (redakt…ô):", a.name || "");
              if(name === null) return;
              const link = prompt("Link (redakt…ô):", a.link || "");
              if(link === null) return;
              adsUpdate(id, {name: name.trim(), link: link.trim()});
              draw();
              toast("Redakt…ô olundu");
            }
          });
        });
      }

      wrap.querySelector("#adsSearch").addEventListener("input", draw);
      draw();
      return wrap;
    }

    // ---- Ads new
    function viewAdsNew(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      wrap.innerHTML = `
        <div class="grid2">
          <div class="field">
            <label>Reklam sayt adƒ±</label>
            <input class="input" id="adName" placeholder="m…ôs: Instagram Reklam" />
          </div>
          <div class="field">
            <label>Link</label>
            <input class="input" id="adLink" placeholder="m…ôs: https://example.com" />
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ok" id="adSave">‚úÖ Yadda saxla</button>
          <button class="btn" id="adBack">‚¨ÖÔ∏è Siyahƒ±ya qayƒ±t</button>
        </div>

        <div class="mini">
          Qeyd: …ôlav…ô etdiyin saytlar ‚ÄúReklam saytlar‚Äù siyahƒ±sƒ±nda g√∂r√ºn…ôc…ôk (axtar / redakt…ô / sil).
        </div>
      `;

      wrap.querySelector("#adBack").addEventListener("click", ()=> go("ads_list"));
      wrap.querySelector("#adSave").addEventListener("click", ()=>{
        const name = (wrap.querySelector("#adName").value||"").trim();
        const link = (wrap.querySelector("#adLink").value||"").trim();
        if(!name) return alert("Ad bo≈ü ola bilm…ôz.");
        if(!link) return alert("Link bo≈ü ola bilm…ôz.");
        adsAdd({name, link});
        toast("∆èlav…ô edildi");
        go("ads_list");
      });

      return wrap;
    }

    // ---- Product new
    function viewProductNew(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      const barcode = genBarcode();
      const searchAuto = genSearchCode();

      wrap.innerHTML = `
        <div class="grid2">
          <div class="field">
            <label>M…ôhsul ≈ü…ôkli (link)</label>
            <input class="input" id="pImage" placeholder="https://.../image.png" />
          </div>
          <div class="field">
            <label>Ad</label>
            <input class="input" id="pName" placeholder="M…ôhsul adƒ±..." />
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Barkod (random LEM-...)</label>
            <div style="display:flex; gap:10px;">
              <input class="input" id="pBarcode" value="${barcode}" />
              <button class="btn" id="regenBarcode">üîÅ</button>
            </div>
          </div>

          <div class="field">
            <label>Axtarƒ±≈ü kodu</label>
            <div style="display:flex; gap:10px; align-items:center;">
              <input class="input" id="pSearch" placeholder="manual: 123456" />
              <button class="btn" id="autoSearch">üé≤ Avto</button>
              <span class="tag">Avto misal: <b id="autoHint">${searchAuto}</b></span>
            </div>
            <div class="mini">Manual yaz (m…ôs: 123456) v…ô ya ‚ÄúAvto‚Äù bas.</div>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Keyfiyy…ôt</label>
            <select id="pQuality"></select>
          </div>
          <div class="field">
            <label>M√ºdd…ôt</label>
            <select id="pDuration"></select>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Say (stok)</label>
            <input class="input" id="pQty" type="number" min="0" value="1" />
          </div>
          <div class="field">
            <label>Qiym…ôt</label>
            <input class="input" id="pPrice" type="number" min="0" step="0.01" value="0" />
          </div>
        </div>

        <div class="field">
          <label>Haqqƒ±nda</label>
          <textarea id="pAbout" placeholder="M…ôhsul haqqƒ±nda..."></textarea>
        </div>

        <div class="grid3">
          <div class="field">
            <label>∆èlaq…ô ‚Ä¢ Telefon</label>
            <input class="input" id="pPhone" placeholder="+994..." />
          </div>
          <div class="field">
            <label>∆èlaq…ô ‚Ä¢ Mail</label>
            <input class="input" id="pMail" placeholder="mail@example.com" />
          </div>
          <div class="field">
            <label>∆èlaq…ô ‚Ä¢ WhatsApp</label>
            <input class="input" id="pWhats" placeholder="+994..." />
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ok" id="pSave">‚úÖ M…ôhsulu …ôlav…ô et</button>
          <button class="btn" id="pGoList">üì¶ M…ôhsullara bax</button>
        </div>
      `;

      // fill selects
      const qSel = wrap.querySelector("#pQuality");
      const dSel = wrap.querySelector("#pDuration");
      QUALITY.forEach(x=>{
        const o = document.createElement("option");
        o.value = x; o.textContent = x;
        qSel.appendChild(o);
      });
      DURATION.forEach(x=>{
        const o = document.createElement("option");
        o.value = x; o.textContent = x;
        dSel.appendChild(o);
      });

      wrap.querySelector("#regenBarcode").addEventListener("click", ()=>{
        wrap.querySelector("#pBarcode").value = genBarcode();
      });
      wrap.querySelector("#autoSearch").addEventListener("click", ()=>{
        const s = genSearchCode();
        wrap.querySelector("#pSearch").value = s;
        wrap.querySelector("#autoHint").textContent = s;
      });
      wrap.querySelector("#pGoList").addEventListener("click", ()=> go("products_list"));

      wrap.querySelector("#pSave").addEventListener("click", ()=>{
        const name = (wrap.querySelector("#pName").value||"").trim();
        if(!name) return alert("M…ôhsul adƒ± bo≈ü ola bilm…ôz.");

        const barcode2 = (wrap.querySelector("#pBarcode").value||"").trim() || genBarcode();
        const searchCode = (wrap.querySelector("#pSearch").value||"").trim() || genSearchCode();

        productAdd({
          image: wrap.querySelector("#pImage").value,
          name,
          barcode: barcode2,
          searchCode,
          quality: qSel.value,
          duration: dSel.value,
          qty: wrap.querySelector("#pQty").value,
          price: wrap.querySelector("#pPrice").value,
          about: wrap.querySelector("#pAbout").value,
          phone: wrap.querySelector("#pPhone").value,
          mail: wrap.querySelector("#pMail").value,
          whatsapp: wrap.querySelector("#pWhats").value
        });
        toast("M…ôhsul …ôlav…ô edildi");
        go("products_list");
      });

      return wrap;
    }

    // ---- Products list (search/filter/edit/delete)
    function viewProductsList(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      wrap.innerHTML = `
        <div class="grid3">
          <div class="field">
            <label>Axtar</label>
            <input class="input" id="pSearchQ" placeholder="ad / barkod / axtarƒ±≈ü kodu..." />
          </div>
          <div class="field">
            <label>Filter ‚Ä¢ Keyfiyy…ôt</label>
            <select id="fQuality">
              <option value="">Hamƒ±sƒ±</option>
            </select>
          </div>
          <div class="field">
            <label>Filter ‚Ä¢ M√ºdd…ôt</label>
            <select id="fDuration">
              <option value="">Hamƒ±sƒ±</option>
            </select>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="goNewProduct">Ôºã M…ôhsul …ôlav…ô et</button>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>≈û…ôkil</th>
                <th>M…ôhsul</th>
                <th>Keyfiyy…ôt / M√ºdd…ôt</th>
                <th>Stok</th>
                <th>Qiym…ôt</th>
                <th>∆èm…ôliyyat</th>
              </tr>
            </thead>
            <tbody id="pTbody"></tbody>
          </table>
        </div>
      `;

      const qSel = wrap.querySelector("#fQuality");
      const dSel = wrap.querySelector("#fDuration");
      QUALITY.forEach(x=>{
        const o = document.createElement("option"); o.value=x; o.textContent=x; qSel.appendChild(o);
      });
      DURATION.forEach(x=>{
        const o = document.createElement("option"); o.value=x; o.textContent=x; dSel.appendChild(o);
      });

      wrap.querySelector("#goNewProduct").addEventListener("click", ()=> go("product_new"));

      function draw(){
        const q = (wrap.querySelector("#pSearchQ").value||"").trim().toLowerCase();
        const fq = wrap.querySelector("#fQuality").value;
        const fd = wrap.querySelector("#fDuration").value;

        const rows = state.products.filter(p=>{
          if(fq && p.quality !== fq) return false;
          if(fd && p.duration !== fd) return false;
          if(!q) return true;
          return (p.name||"").toLowerCase().includes(q) ||
                 (p.barcode||"").toLowerCase().includes(q) ||
                 (p.searchCode||"").toLowerCase().includes(q);
        });

        const tb = wrap.querySelector("#pTbody");
        tb.innerHTML = rows.map(p=>`
          <tr>
            <td style="width:100px;">
              ${p.image ? `<img src="${escapeHtml(p.image)}" alt="" style="width:80px; height:50px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.12);" />`
                        : `<span class="tag">yoxdur</span>`}
            </td>
            <td>
              <b>${escapeHtml(p.name)}</b>
              <small>Barkod: ${escapeHtml(p.barcode)} ‚Ä¢ Axtarƒ±≈ü kodu: ${escapeHtml(p.searchCode)}</small>
            </td>
            <td>
              <span class="tag">üéû ${escapeHtml(p.quality)}</span>
              <span class="tag">‚è≥ ${escapeHtml(p.duration)}</span>
            </td>
            <td><b>${p.qty}</b></td>
            <td><b>${fmtMoney(p.price)}</b></td>
            <td>
              <div class="rowActions">
                <button class="btn" data-act="edit" data-id="${p.id}">‚úèÔ∏è Redakt…ô</button>
                <button class="btn danger" data-act="del" data-id="${p.id}">üóë Sil</button>
              </div>
            </td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="mini" style="padding:14px;">He√ß n…ô tapƒ±lmadƒ±.</td></tr>`;

        tb.querySelectorAll("button[data-act]").forEach(btn=>{
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          btn.addEventListener("click", ()=>{
            const p = state.products.find(x=>x.id===id);
            if(!p) return;

            if(act === "del"){
              productDelete(id);
              draw();
              toast("Silindi");
              return;
            }

            // edit (simple prompt edits)
            const newName = prompt("Ad:", p.name || "");
            if(newName === null) return;
            const newPrice = prompt("Qiym…ôt:", String(p.price ?? 0));
            if(newPrice === null) return;
            const newQty = prompt("Stok (say):", String(p.qty ?? 0));
            if(newQty === null) return;

            productUpdate(id, {
              name: newName.trim(),
              price: Number(newPrice),
              qty: Number(newQty)
            });
            draw();
            toast("Redakt…ô olundu");
          });
        });
      }

      wrap.querySelector("#pSearchQ").addEventListener("input", draw);
      wrap.querySelector("#fQuality").addEventListener("change", draw);
      wrap.querySelector("#fDuration").addEventListener("change", draw);

      draw();
      return wrap;
    }

    // ---- POS view
    function viewPOS(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      wrap.innerHTML = `
        <div class="grid2">
          <div class="field">
            <label>M…ôhsul axtar (ad / barkod / axtarƒ±≈ü kodu)</label>
            <input class="input" id="posSearch" placeholder="m…ôs: Netflix, LEM-..., 123456" />
            <div class="mini">Tapƒ±lanlar a≈üaƒüƒ±da √ßƒ±xacaq. Oradan ‚ÄúSe√ß‚úÖ‚Äù edib ‚ÄúSay‚Äù yazƒ±b s…ôb…ôt…ô at.</div>
          </div>

          <div class="field">
            <label>Se√ßil…ôn m…ôhsul ‚úÖ</label>
            <div id="selectedBox" class="mini">He√ß n…ô se√ßilm…ôyib.</div>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center;">
              <input class="input" id="posCount" type="number" min="1" value="1" style="width:120px;">
              <button class="btn ok" id="addToCart">üß∫ S…ôb…ôt…ô …ôlav…ô et</button>
            </div>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Tapƒ±lan m…ôhsullar</th>
                <th>Qiym…ôt</th>
                <th>Stok</th>
                <th>Se√ß‚úÖ</th>
              </tr>
            </thead>
            <tbody id="posResults"></tbody>
          </table>
        </div>

        <div class="grid2">
          <div class="field">
            <label>S…ôb…ôt</label>
            <div class="tableWrap" style="max-height:220px;">
              <table>
                <thead>
                  <tr>
                    <th>M…ôhsul</th>
                    <th>Say</th>
                    <th>Qiym…ôt</th>
                    <th>Sil</th>
                  </tr>
                </thead>
                <tbody id="cartBody"></tbody>
              </table>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button class="btn danger" id="cartClear">üßπ S…ôb…ôti t…ômizl…ô</button>
            </div>
          </div>

          <div class="field">
            <label>S…ôb…ôti t…ôsdiql…ô</label>
            <div class="mini" id="cartSummary"></div>

            <div class="grid2" style="margin-top:10px;">
              <div class="field">
                <label>Endirim</label>
                <input class="input" id="discountInp" type="number" min="0" step="0.01" value="0">
              </div>
              <div class="field">
                <label>Alƒ±nan m…ôbl…ôq</label>
                <input class="input" id="paidInp" type="number" min="0" step="0.01" value="0">
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button class="btn ok" id="completeSale">‚úÖ Satƒ±≈üƒ± tamamla</button>
              <button class="btn" id="printSale">üñ® √áap et</button>
              <button class="btn" id="pdfSale">üìÑ PDF</button>
            </div>

            <div class="mini" style="margin-top:10px;">
              Qeyd: ‚ÄúSatƒ±≈üƒ± tamamla‚Äù stokdan d√º≈ü√ºr√ºr v…ô satƒ±≈ü tarix√ß…ôsin…ô yazƒ±r.
            </div>
          </div>
        </div>

        <div class="field">
          <label>Son satƒ±≈ülar (son 5)</label>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Tarix</th>
                  <th>M…ôhsul sayƒ±</th>
                  <th>Toplam</th>
                  <th>Endirim</th>
                  <th>√ñd…ônil…ôc…ôk</th>
                  <th>Q…ôbz</th>
                </tr>
              </thead>
              <tbody id="salesBody"></tbody>
            </table>
          </div>
        </div>
      `;

      const selectedBox = wrap.querySelector("#selectedBox");
      const searchInp = wrap.querySelector("#posSearch");
      const resultsTb = wrap.querySelector("#posResults");
      const countInp = wrap.querySelector("#posCount");

      const cartBody = wrap.querySelector("#cartBody");
      const cartSummary = wrap.querySelector("#cartSummary");
      const discountInp = wrap.querySelector("#discountInp");
      const paidInp = wrap.querySelector("#paidInp");

      const salesBody = wrap.querySelector("#salesBody");

      function setSelected(productId){
        cart.selectedProductId = productId;
        const p = state.products.find(x=>x.id===productId);
        if(!p){
          selectedBox.textContent = "He√ß n…ô se√ßilm…ôyib.";
          return;
        }
        selectedBox.innerHTML = `
          <b>${escapeHtml(p.name)}</b><br/>
          <small>Barkod: ${escapeHtml(p.barcode)} ‚Ä¢ Kod: ${escapeHtml(p.searchCode)}</small><br/>
          <span class="tag">Stok: <b>${p.qty}</b></span>
          <span class="tag">Qiym…ôt: <b>${fmtMoney(p.price)}</b></span>
        `;
      }

      function drawResults(){
        const q = (searchInp.value||"").trim().toLowerCase();
        let rows = [];
        if(q){
          rows = findProductByAny(q);
        }else{
          rows = state.products.slice(0, 15); // show first items
        }

        resultsTb.innerHTML = rows.map(p=>`
          <tr>
            <td>
              <b>${escapeHtml(p.name)}</b>
              <small>${escapeHtml(p.barcode)} ‚Ä¢ ${escapeHtml(p.searchCode)}</small>
            </td>
            <td><b>${fmtMoney(p.price)}</b></td>
            <td><b>${p.qty}</b></td>
            <td>
              <button class="btn ok" data-sel="${p.id}">Se√ß‚úÖ</button>
            </td>
          </tr>
        `).join("") || `<tr><td colspan="4" class="mini" style="padding:14px;">M…ôhsul yoxdur.</td></tr>`;

        resultsTb.querySelectorAll("button[data-sel]").forEach(b=>{
          b.addEventListener("click", ()=>{
            setSelected(b.dataset.sel);
            toast("Se√ßildi");
          });
        });
      }

      function drawCart(){
        const entries = Array.from(cart.items.entries());
        cartBody.innerHTML = entries.map(([pid, count])=>{
          const p = state.products.find(x=>x.id===pid);
          if(!p) return "";
          return `
            <tr>
              <td>
                <b>${escapeHtml(p.name)}</b>
                <small>${escapeHtml(p.barcode)} ‚Ä¢ ${escapeHtml(p.searchCode)}</small>
              </td>
              <td><b>${count}</b></td>
              <td><b>${fmtMoney(p.price)}</b></td>
              <td><button class="btn danger" data-del="${pid}">Sil</button></td>
            </tr>
          `;
        }).join("") || `<tr><td colspan="4" class="mini" style="padding:14px;">S…ôb…ôt bo≈üdur.</td></tr>`;

        cartBody.querySelectorAll("button[data-del]").forEach(b=>{
          b.addEventListener("click", ()=>{
            cartRemove(b.dataset.del);
            drawCart();
            drawSummary();
          });
        });
      }

      function drawSummary(){
        cart.discount = Number(discountInp.value||0);
        cart.paid = Number(paidInp.value||0);
        const t = cartTotals();

        cartSummary.innerHTML = `
          <div class="tag">Toplam m…ôhsul sayƒ±: <b>${t.totalQty}</b></div>
          <div class="tag">Toplam tutar: <b>${fmtMoney(t.total)}</b></div>
          <div class="tag">Endirim: <b>${fmtMoney(t.discount)}</b></div>
          <div class="tag">√ñd…ônil…ôc…ôk: <b>${fmtMoney(t.finalTotal)}</b></div>
          <div class="tag">Alƒ±nan m…ôbl…ôq: <b>${fmtMoney(t.paid)}</b></div>
          <div class="tag">Qaytarƒ±lacaq m…ôbl…ôƒü: <b>${fmtMoney(t.change)}</b></div>
        `;
      }

      function drawSales(){
        const rows = state.sales.slice(0,5);
        salesBody.innerHTML = rows.map(s=>`
          <tr>
            <td>${new Date(s.createdAt).toLocaleString("az-AZ")}</td>
            <td><b>${s.totals.qty}</b></td>
            <td><b>${fmtMoney(s.totals.total)}</b></td>
            <td><b>${fmtMoney(s.totals.discount)}</b></td>
            <td><b>${fmtMoney(s.totals.finalTotal)}</b></td>
            <td><button class="btn" data-receipt="${s.id}">Q…ôbz</button></td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="mini" style="padding:14px;">Satƒ±≈ü yoxdur.</td></tr>`;

        salesBody.querySelectorAll("button[data-receipt]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const s = state.sales.find(x=>x.id===b.dataset.receipt);
            if(!s) return;
            openPrintWindow(renderReceiptHTML(s), "Q…ôbz");
          });
        });
      }

      wrap.querySelector("#addToCart").addEventListener("click", ()=>{
        const pid = cart.selectedProductId;
        if(!pid) return alert("∆èvv…ôl m…ôhsul se√ß‚úÖ");
        const cnt = clamp(countInp.value, 1, 1000000);
        cartAdd(pid, cnt);
        drawCart();
        drawSummary();
      });

      wrap.querySelector("#cartClear").addEventListener("click", ()=>{
        if(!confirm("S…ôb…ôt t…ômizl…ônsin?")) return;
        cart.items.clear();
        drawCart();
        drawSummary();
        toast("S…ôb…ôt t…ômizl…ôndi");
      });

      discountInp.addEventListener("input", drawSummary);
      paidInp.addEventListener("input", drawSummary);
      searchInp.addEventListener("input", drawResults);

      // complete sale
      wrap.querySelector("#completeSale").addEventListener("click", ()=>{
        cart.discount = Number(discountInp.value||0);
        cart.paid = Number(paidInp.value||0);

        const t = cartTotals();
        if(t.totalQty <= 0) return alert("S…ôb…ôt bo≈üdur.");
        if(t.paid < t.finalTotal){
          if(!confirm("Alƒ±nan m…ôbl…ôƒü √∂d…ônil…ôc…ôkd…ôn azdƒ±r. Yen…ô d…ô satƒ±≈üƒ± tamamlayƒ±m?")) return;
        }

        const res = cartConfirmAndComplete();
        if(!res) return;
        // after complete, refresh UI
        drawResults();
        drawCart();
        drawSummary();
        drawSales();

        // open receipt preview
        openPrintWindow(res.receiptHtml, "Satƒ±≈ü Q…ôbzi");
      });

      // print / pdf (without completing)
      function previewCurrentCart(){
        const itemsArr = [];
        for(const [pid, count] of cart.items.entries()){
          const p = state.products.find(x=>x.id===pid);
          if(!p) continue;
          itemsArr.push({ productId: pid, name: p.name, price: Number(p.price)||0, count });
        }
        if(itemsArr.length === 0) return null;

        const t = cartTotals();
        const saleLike = {
          id: "PREVIEW",
          createdAt: Date.now(),
          items: itemsArr,
          totals: {
            qty: t.totalQty,
            total: t.total,
            discount: t.discount,
            finalTotal: t.finalTotal,
            paid: t.paid,
            change: t.change
          }
        };
        return renderReceiptHTML(saleLike);
      }

      wrap.querySelector("#printSale").addEventListener("click", ()=>{
        cart.discount = Number(discountInp.value||0);
        cart.paid = Number(paidInp.value||0);
        const html = previewCurrentCart();
        if(!html) return alert("S…ôb…ôt bo≈üdur.");
        openPrintWindow(html, "Q…ôbz (Preview)");
      });

      wrap.querySelector("#pdfSale").addEventListener("click", ()=>{
        cart.discount = Number(discountInp.value||0);
        cart.paid = Number(paidInp.value||0);
        const html = previewCurrentCart();
        if(!html) return alert("S…ôb…ôt bo≈üdur.");
        openPrintWindow(html, "PDF (Preview)");
      });

      // init
      setSelected(cart.selectedProductId);
      drawResults();
      drawCart();
      drawSummary();
      drawSales();
      return wrap;
    }

    // -------------------- Init --------------------
    go("pos");
  </script>
</body>
</html>
