<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LionEMarket POS (Offline)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0b1628;
      --text:#e8eefc;
      --muted:#9db0d0;
      --line:#1f3158;
      --accent:#6ea8ff;
      --accent2:#79ffd7;
      --danger:#ff6b6b;
      --ok:#7CFF8A;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(110,168,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(121,255,215,.12), transparent 60%),
                  linear-gradient(180deg, #070c16, var(--bg));
      min-height:100vh;
    }
    .app{ max-width:1300px; margin:20px auto; padding:16px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position:sticky; top:14px; z-index:20;
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background:
        radial-gradient(10px 10px at 30% 30%, rgba(255,255,255,.65), transparent 60%),
        linear-gradient(135deg, rgba(110,168,255,.95), rgba(121,255,215,.95));
      box-shadow: 0 10px 25px rgba(110,168,255,.25);
    }
    .brand h1{ margin:0; font-size:14px; letter-spacing:.3px; font-weight:800; }
    .brand small{ color:var(--muted); display:block; margin-top:2px; font-weight:500; }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end; }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      transition: .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(110,168,255,.6) }
    .btn:active{ transform: translateY(0px); opacity:.9 }
    .btn.primary{ border-color: rgba(110,168,255,.6); background: rgba(110,168,255,.13); }
    .btn.ok{ border-color: rgba(124,255,138,.6); background: rgba(124,255,138,.10); }
    .btn.danger{ border-color: rgba(255,107,107,.6); background: rgba(255,107,107,.12); }
    .btn.ghost{ background: transparent; }
    .pill{
      font-family:var(--mono);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:14px;
      align-items:start;
    }

    .panel{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 540px;
    }
    .panelHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .panelHead strong{ font-size:13px; }
    .panelBody{ padding:14px; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .grid1{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (max-width: 980px){
      .layout{ grid-template-columns:1fr; }
    }

    .field{
      display:flex; flex-direction:column; gap:6px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
    }
    .field label{ font-size:12px; color:var(--muted); }
    .input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:12px;
      font-family: var(--mono);
    }
    textarea{ min-height:84px; resize:vertical; font-family: var(--sans); }
    .input:focus, select:focus, textarea:focus{
      border-color: rgba(110,168,255,.6);
      box-shadow: 0 0 0 4px rgba(110,168,255,.12);
    }

    .tableWrap{
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      overflow:auto;
      background: rgba(0,0,0,.12);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size:12px;
    }
    th, td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:10px 10px;
      text-align:left;
      vertical-align:top;
    }
    th{
      position:sticky; top:0; z-index:2;
      background: rgba(0,0,0,.25);
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    td small{ color:var(--muted); display:block; margin-top:4px; }
    .rowActions{ display:flex; flex-wrap:wrap; gap:8px; }
    .tag{
      display:inline-flex;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:11px;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }

    /* Right sidebar */
    .sidebar{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:sticky;
      top:86px;
    }
    .sideHead{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sideHead strong{ font-size:13px; }
    .sideBody{ padding:10px; display:flex; flex-direction:column; gap:8px; }

    .navGroup{
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,.14);
    }
    .navTitle{
      padding:10px 10px;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
      user-select:none;
      color:var(--text);
      font-weight:800;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .navTitle span{ color:var(--muted); font-weight:700; }
    .navItems{ padding:8px; display:flex; flex-direction:column; gap:8px; }
    .navBtn{
      width:100%;
      text-align:left;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      display:flex; align-items:center; justify-content:space-between;
    }
    .navBtn:hover{ border-color: rgba(110,168,255,.55); }
    .navBtn.active{
      border-color: rgba(121,255,215,.65);
      box-shadow: 0 0 0 4px rgba(121,255,215,.12);
      background: rgba(121,255,215,.08);
    }

    .mini{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .toggleWrap{ display:flex; align-items:center; gap:10px; }
    .sidebar.hidden{ display:none; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:12px;
      color:var(--text);
      font-size:12px;
      box-shadow: var(--shadow);
      display:none;
      z-index:99;
      max-width: 92vw;
    }

    /* Login overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:16px;
    }
    .modal{
      width:min(520px, 96vw);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,16,30,.92);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.22);
    }
    .modalBody{ padding:14px; }
    .modalHead b{ font-size:13px; }
    .hint{
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(0,0,0,.15);
      color: var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    /* Receipt (print) */
    .receipt{
      font-family: var(--mono);
      color:#111;
    }
    .receipt h2{ margin:0 0 8px 0; font-size:18px; }
    .receipt .muted{ color:#444; font-size:12px; }
    .receipt table{ border-collapse:collapse; width:100%; font-size:12px; }
    .receipt th, .receipt td{ border-bottom:1px solid #ddd; padding:8px; text-align:left; }
    .receipt .sum{ margin-top:10px; border-top:2px solid #111; padding-top:10px; }
    .receipt .sum div{ display:flex; justify-content:space-between; padding:3px 0; }

    /* report mini cards */
    .cards{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    @media (max-width: 1100px){ .cards{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 620px){ .cards{ grid-template-columns: 1fr;} }
    .card{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      border-radius:14px;
      padding:12px;
    }
    .card .k{ color:var(--muted); font-size:12px; }
    .card .v{ font-family:var(--mono); font-size:18px; font-weight:900; margin-top:6px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>LionEMarket POS (Offline)</h1>
          <small>Parol ‚Ä¢ Satƒ±≈ü tarix√ß…ôsi PDF ‚Ä¢ G√ºnl√ºk/Aylƒ±q hesabat ‚Ä¢ Windows .exe √º√ß√ºn hazƒ±r</small>
        </div>
      </div>

      <div class="actions">
        <span class="pill" id="statusPill">Hazƒ±r ‚úÖ</span>
        <button class="btn" id="lockBtn" title="POS-u kilidl…ô">üîí Lock</button>
        <button class="btn danger" id="wipeAllBtn" title="B√ºt√ºn datanƒ± sil">üß® Reset</button>
      </div>
    </div>

    <div class="layout">
      <div class="panel">
        <div class="panelHead">
          <strong id="viewTitle">Satƒ±≈ü Kassa</strong>
          <div class="rowActions">
            <button class="btn" id="exportDataBtn" title="Backup √º√ß√ºn data.json endir">üíæ Backup (data.json)</button>
            <button class="btn" id="importDataBtn">üì• Import JSON</button>
            <input id="importFile" type="file" accept="application/json" hidden>
            <button class="btn danger" id="logoutBtn" title="√áƒ±xƒ±≈ü">üö™ Logout</button>
          </div>
        </div>
        <div class="panelBody" id="viewHost"></div>
      </div>

      <div class="sidebar" id="sidebar">
        <div class="sideHead">
          <strong>Saƒü Menyu</strong>
          <button class="btn" id="hideSideBtn">Gizl…ôt</button>
        </div>

        <div class="sideBody">
          <div class="navGroup" data-open="1">
            <div class="navTitle">
              <div>üì£ Reklam saytlar</div>
              <span>idar…ô</span>
            </div>
            <div class="navItems">
              <button class="navBtn" data-view="ads_list">Axtar / Redakt…ô / Sil <span>‚Üí</span></button>
              <button class="navBtn" data-view="ads_new">Yeni reklam sayt <span>Ôºã</span></button>
            </div>
          </div>

          <div class="navGroup" data-open="1">
            <div class="navTitle">
              <div>üßæ Satƒ±≈ü kassa</div>
              <span>POS</span>
            </div>
            <div class="navItems">
              <button class="navBtn active" data-view="pos">Kassa <span>‚úÖ</span></button>
            </div>
          </div>

          <div class="navGroup" data-open="1">
            <div class="navTitle">
              <div>üì¶ M…ôhsullar</div>
              <span>baza</span>
            </div>
            <div class="navItems">
              <button class="navBtn" data-view="product_new">M…ôhsul …ôlav…ô et <span>Ôºã</span></button>
              <button class="navBtn" data-view="products_list">M…ôhsullar (axtar/filter) <span>‚Üí</span></button>
            </div>
          </div>

          <div class="navGroup" data-open="1">
            <div class="navTitle">
              <div>üìä Hesabat / Tarix√ß…ô</div>
              <span>report</span>
            </div>
            <div class="navItems">
              <button class="navBtn" data-view="sales_history">üßæ Satƒ±≈ü tarix√ß…ôsi (PDF) <span>‚Üí</span></button>
              <button class="navBtn" data-view="reports">üìä G√ºnl√ºk / Aylƒ±q hesabat <span>‚Üí</span></button>
              <button class="navBtn" data-view="settings">‚öôÔ∏è Ayarlar (Parol) <span>‚Üí</span></button>
            </div>
          </div>

          <div class="mini">
            Q…ôbz/PDF: print p…ônc…ôr…ôsi a√ßƒ±lƒ±r ‚Üí ‚ÄúSave as PDF‚Äù.
            <br/><br/>
            Backup: ‚ÄúBackup(data.json)‚Äù endir ‚Üí GitHub-a upload/commit (manual).
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <!-- LOGIN OVERLAY -->
  <div class="overlay" id="authOverlay">
    <div class="modal">
      <div class="modalHead">
        <b id="authTitle">üîê POS Giri≈ü</b>
        <span class="tag" id="authModeTag">offline</span>
      </div>
      <div class="modalBody" id="authBody"></div>
    </div>
  </div>

  <script>
    // -------------------- Utils --------------------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function uid(prefix="id"){
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display = "none", 1800);
    }
    function fmtMoney(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return "0.00";
      return x.toFixed(2);
    }
    function clamp(n, a, b){
      n = Number(n);
      if(!Number.isFinite(n)) return a;
      return Math.max(a, Math.min(b, n));
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function formatDateISO(d){
      // yyyy-mm-dd
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    function startOfDay(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }
    function endOfDay(d){
      const x = new Date(d);
      x.setHours(23,59,59,999);
      return x;
    }

    // Barcode: LEM-12345678910
    function genBarcode(){
      const digits = 11;
      let s = "";
      for(let i=0;i<digits;i++) s += Math.floor(Math.random()*10);
      return "LEM-" + s;
    }
    // Search code: 6 digits random (example: 123456)
    function genSearchCode(){
      let s = "";
      for(let i=0;i<6;i++) s += Math.floor(Math.random()*10);
      return s;
    }

    // -------------------- Simple SHA-256 --------------------
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b => b.toString(16).padStart(2,"0")).join("");
    }

    // -------------------- Storage --------------------
    const KEY_DB = "pos_app_v2_db";
    const KEY_AUTH = "pos_app_v2_auth"; // {passHash, isSetup}
    const KEY_SESSION = "pos_app_v2_session"; // {unlockedUntil}

    const defaultState = () => ({
      ads: [],
      products: [],
      sales: [] // {id, createdAt, items:[{productId,name,price,count}], totals:{qty,total,discount,finalTotal,paid,change}}
    });

    let state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(KEY_DB);
        if(!raw) return defaultState();
        const obj = JSON.parse(raw);
        if(!obj || typeof obj !== "object") return defaultState();
        obj.ads ??= [];
        obj.products ??= [];
        obj.sales ??= [];
        return obj;
      }catch{
        return defaultState();
      }
    }
    function saveState(){
      localStorage.setItem(KEY_DB, JSON.stringify(state));
      $("#statusPill").textContent = "Yadda saxlandƒ± ‚úÖ";
      clearTimeout(saveState._tm);
      saveState._tm = setTimeout(()=> $("#statusPill").textContent = "Hazƒ±r ‚úÖ", 900);
    }

    function wipeAll(){
      if(!confirm("B√úT√úN m…ôlumatlar silinsin? (Reklam saytlar, M…ôhsullar, Satƒ±≈ülar)")) return;
      state = defaultState();
      saveState();
      cartReset();
      go("pos");
      toast("Reset edildi");
    }
    $("#wipeAllBtn").addEventListener("click", wipeAll);

    // -------------------- Backup / Import --------------------
    $("#exportDataBtn").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "data.json";
      a.click();
      URL.revokeObjectURL(a.href);
      toast("data.json endirildi ‚úÖ (backup)");
    });

    $("#importDataBtn").addEventListener("click", ()=> $("#importFile").click());
    $("#importFile").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        const text = await f.text();
        const obj = JSON.parse(text);
        if(!obj || typeof obj !== "object") throw new Error("bad");
        obj.ads ??= [];
        obj.products ??= [];
        obj.sales ??= [];
        state = obj;
        saveState();
        cartReset();
        go("pos");
        toast("Import olundu");
      }catch{
        alert("JSON d√ºzg√ºn deyil / oxunmadƒ±.");
      }finally{
        e.target.value = "";
      }
    });

    // -------------------- Auth (Password) --------------------
    function getAuth(){
      try{
        const raw = localStorage.getItem(KEY_AUTH);
        if(!raw) return { isSetup:false, passHash:"" };
        const o = JSON.parse(raw);
        return { isSetup: !!o.isSetup, passHash: String(o.passHash||"") };
      }catch{
        return { isSetup:false, passHash:"" };
      }
    }
    function setAuth(passHash){
      localStorage.setItem(KEY_AUTH, JSON.stringify({ isSetup:true, passHash }));
    }

    function getSession(){
      try{
        const raw = localStorage.getItem(KEY_SESSION);
        if(!raw) return { unlockedUntil: 0 };
        const o = JSON.parse(raw);
        return { unlockedUntil: Number(o.unlockedUntil||0) };
      }catch{
        return { unlockedUntil: 0 };
      }
    }
    function setSessionUnlocked(minutes=240){
      const until = Date.now() + minutes*60*1000;
      localStorage.setItem(KEY_SESSION, JSON.stringify({ unlockedUntil: until }));
    }
    function clearSession(){
      localStorage.setItem(KEY_SESSION, JSON.stringify({ unlockedUntil: 0 }));
    }
    function isUnlocked(){
      const s = getSession();
      return Date.now() < s.unlockedUntil;
    }

    function showAuthOverlay(html){
      $("#authBody").innerHTML = html;
      $("#authOverlay").style.display = "flex";
    }
    function hideAuthOverlay(){
      $("#authOverlay").style.display = "none";
    }

    async function requireAuth(force=false){
      const auth = getAuth();
      if(!force && auth.isSetup && isUnlocked()) return true;

      if(!auth.isSetup){
        // First-time setup
        showAuthOverlay(`
          <div class="hint">
            ƒ∞lk d…ôf…ô a√ßƒ±lƒ±r. ƒ∞ndi POS √º√ß√ºn <b>admin parol</b> t…ôyin et.
            <br/>Bu parol olmadan POS a√ßƒ±lmayacaq.
          </div>
          <div class="grid1" style="margin-top:12px;">
            <div class="field">
              <label>Yeni parol</label>
              <input class="input" id="p1" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div class="field">
              <label>Parolu t…ôkrar yaz</label>
              <input class="input" id="p2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <button class="btn ok" id="setPassBtn">‚úÖ Parolu t…ôyin et v…ô a√ß</button>
          </div>
        `);

        $("#setPassBtn").addEventListener("click", async ()=>{
          const p1 = ($("#p1").value||"").trim();
          const p2 = ($("#p2").value||"").trim();
          if(p1.length < 4) return alert("Parol …ôn az 4 simvol olsun.");
          if(p1 !== p2) return alert("Parollar eyni deyil.");
          const h = await sha256(p1);
          setAuth(h);
          setSessionUnlocked(240);
          hideAuthOverlay();
          toast("Parol t…ôyin olundu ‚úÖ");
        });
        return false;
      }else{
        // Login
        showAuthOverlay(`
          <div class="hint">
            POS kilidlidir. A√ßmaq √º√ß√ºn parolu yaz.
          </div>
          <div class="grid1" style="margin-top:12px;">
            <div class="field">
              <label>Parol</label>
              <input class="input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn ok" id="loginBtn">üîì A√ß</button>
              <button class="btn" id="exitBtn">‚ùå Baƒüla</button>
            </div>
            <div class="mini">Qeyd: S…ôhv parol yazsan a√ßƒ±lmayacaq.</div>
          </div>
        `);

        $("#loginBtn").addEventListener("click", async ()=>{
          const p = ($("#loginPass").value||"").trim();
          const h = await sha256(p);
          const a = getAuth();
          if(h !== a.passHash) return alert("Parol s…ôhvdir.");
          setSessionUnlocked(240);
          hideAuthOverlay();
          toast("A√ßƒ±ldƒ± ‚úÖ");
          render(currentView);
        });
        $("#exitBtn").addEventListener("click", ()=>{
          // For browser: just keep locked
          toast("POS kilidli qaldƒ± üîí");
        });
        return false;
      }
    }

    $("#lockBtn").addEventListener("click", ()=>{
      clearSession();
      toast("Kilidl…ôndi üîí");
      requireAuth(true);
    });
    $("#logoutBtn").addEventListener("click", ()=>{
      clearSession();
      toast("√áƒ±xƒ±≈ü edildi üö™");
      requireAuth(true);
    });

    // -------------------- Navigation --------------------
    const titles = {
      pos: "Satƒ±≈ü Kassa",
      ads_list: "Reklam saytlar ‚Ä¢ Axtar / Redakt…ô / Sil",
      ads_new: "Yeni reklam sayt",
      product_new: "M…ôhsul …ôlav…ô et",
      products_list: "M…ôhsullar ‚Ä¢ Axtar / Filter",
      sales_history: "Satƒ±≈ü tarix√ß…ôsi ‚Ä¢ PDF export",
      reports: "G√ºnl√ºk / Aylƒ±q hesabat",
      settings: "Ayarlar ‚Ä¢ Parol"
    };

    let currentView = "pos";

    function setActiveNav(view){
      $$(".navBtn").forEach(b => b.classList.toggle("active", b.dataset.view === view));
      $("#viewTitle").textContent = titles[view] || "Panel";
    }

    async function go(view){
      currentView = view;
      setActiveNav(view);
      const ok = await requireAuth(false);
      if(!ok) return; // locked
      render(view);
    }

    $$(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=> go(btn.dataset.view));
    });

    // group toggle
    $$(".navTitle").forEach(title=>{
      title.addEventListener("click", ()=>{
        const group = title.closest(".navGroup");
        const items = group.querySelector(".navItems");
        const open = group.getAttribute("data-open") === "1";
        group.setAttribute("data-open", open ? "0" : "1");
        items.style.display = open ? "none" : "flex";
      });
    });

    // sidebar hide/show
    function hideSidebar(){ $("#sidebar").classList.add("hidden"); }
    $("#hideSideBtn").addEventListener("click", hideSidebar);

    // -------------------- Ads --------------------
    function adsAdd({name, link}){
      state.ads.unshift({ id: uid("ad"), name:(name||"").trim(), link:(link||"").trim(), createdAt: Date.now() });
      saveState();
    }
    function adsUpdate(id, patch){
      const x = state.ads.find(a => a.id === id);
      if(!x) return;
      Object.assign(x, patch);
      saveState();
    }
    function adsDelete(id){
      state.ads = state.ads.filter(a => a.id !== id);
      saveState();
    }

    // -------------------- Products --------------------
    const QUALITY = [
      "Standard with ads (1080p)",
      "Standard (1080p)",
      "Premium (4K + HDR)"
    ];
    const DURATION = ["1ay","3ay","6ay","12ay"];

    function productAdd(p){
      state.products.unshift({
        id: uid("prd"),
        image: (p.image||"").trim(),
        name: (p.name||"").trim(),
        barcode: (p.barcode||"").trim(),
        searchCode: (p.searchCode||"").trim(),
        quality: p.quality || QUALITY[0],
        duration: p.duration || DURATION[0],
        qty: clamp(p.qty, 0, 1000000),
        price: clamp(p.price, 0, 100000000),
        about: (p.about||"").trim(),
        phone: (p.phone||"").trim(),
        mail: (p.mail||"").trim(),
        whatsapp: (p.whatsapp||"").trim(),
        createdAt: Date.now()
      });
      saveState();
    }
    function productUpdate(id, patch){
      const x = state.products.find(p=>p.id===id);
      if(!x) return;
      Object.assign(x, patch);
      if("qty" in patch) x.qty = clamp(x.qty, 0, 1000000);
      if("price" in patch) x.price = clamp(x.price, 0, 100000000);
      saveState();
    }
    function productDelete(id){
      if(!confirm("M…ôhsul silinsin?")) return;
      state.products = state.products.filter(p=>p.id!==id);
      saveState();
    }
    function findProductByAny(query){
      const q = (query||"").trim().toLowerCase();
      if(!q) return [];
      return state.products.filter(p=>{
        const a = (p.name||"").toLowerCase();
        const b = (p.barcode||"").toLowerCase();
        const c = (p.searchCode||"").toLowerCase();
        return a.includes(q) || b.includes(q) || c.includes(q);
      });
    }

    // -------------------- POS Cart --------------------
    let cart = { selectedProductId:null, items:new Map(), discount:0, paid:0 };
    function cartReset(){ cart = { selectedProductId:null, items:new Map(), discount:0, paid:0 }; }
    function cartAdd(productId, count){
      const p = state.products.find(x=>x.id===productId);
      if(!p) return toast("M…ôhsul tapƒ±lmadƒ±");
      count = clamp(count, 1, 1000000);
      const existing = cart.items.get(productId) || 0;
      const totalWanted = existing + count;
      if(totalWanted > p.qty){
        return alert(`Stok √ßatmƒ±r. M√∂vcud stok: ${p.qty}\nS…ôb…ôtd…ô olan: ${existing}\nƒ∞st…ôdiyin …ôlav…ô: ${count}`);
      }
      cart.items.set(productId, totalWanted);
      toast("S…ôb…ôt…ô …ôlav…ô edildi");
    }
    function cartRemove(productId){ cart.items.delete(productId); }
    function cartTotals(){
      let totalQty = 0;
      let total = 0;
      for(const [pid, count] of cart.items.entries()){
        const p = state.products.find(x=>x.id===pid);
        if(!p) continue;
        totalQty += count;
        total += (Number(p.price)||0) * count;
      }
      const discount = clamp(cart.discount, 0, 100000000);
      const finalTotal = Math.max(0, total - discount);
      const paid = clamp(cart.paid, 0, 100000000);
      const change = Math.max(0, paid - finalTotal);
      return { totalQty, total, discount, finalTotal, paid, change };
    }

    function cartConfirmAndComplete(){
      const itemsArr = [];
      for(const [pid, count] of cart.items.entries()){
        const p = state.products.find(x=>x.id===pid);
        if(!p) continue;
        itemsArr.push({ productId: pid, name: p.name, price: Number(p.price)||0, count });
      }
      if(itemsArr.length === 0) return alert("S…ôb…ôt bo≈üdur.");

      const totals = cartTotals();

      // stock check then reduce
      for(const it of itemsArr){
        const p = state.products.find(x=>x.id===it.productId);
        if(!p) continue;
        if(it.count > p.qty) return alert(`Stok d…ôyi≈üib! "${p.name}" √º√ß√ºn stok √ßatmƒ±r. M√∂vcud: ${p.qty}`);
      }
      for(const it of itemsArr){
        const p = state.products.find(x=>x.id===it.productId);
        if(!p) continue;
        p.qty = clamp(p.qty - it.count, 0, 1000000);
      }

      const sale = {
        id: uid("sale"),
        createdAt: Date.now(),
        items: itemsArr,
        totals: {
          qty: totals.totalQty,
          total: totals.total,
          discount: totals.discount,
          finalTotal: totals.finalTotal,
          paid: totals.paid,
          change: totals.change
        }
      };
      state.sales.unshift(sale);
      saveState();

      const receiptHtml = renderReceiptHTML(sale);
      cartReset();
      toast("Satƒ±≈ü tamamlandƒ± ‚úÖ");
      return { sale, receiptHtml };
    }

    function renderReceiptHTML(sale){
      const rows = sale.items.map(it=>{
        const lineTotal = (it.price * it.count);
        return `
          <tr>
            <td>${escapeHtml(it.name)}</td>
            <td>${fmtMoney(it.price)}</td>
            <td>${it.count}</td>
            <td>${fmtMoney(lineTotal)}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="receipt">
          <h2>Satƒ±≈ü Q…ôbzi</h2>
          <div class="muted">Tarix/Saat: ${new Date(sale.createdAt).toLocaleString("az-AZ")}</div>
          <div class="muted">Satƒ±≈ü ID: ${sale.id}</div>
          <br/>
          <table>
            <thead>
              <tr>
                <th>Mehsul adlarƒ±</th>
                <th>Qiym…ôt</th>
                <th>Say</th>
                <th>Toplam</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>

          <div class="sum">
            <div><b>Toplam M…ôhsul sayƒ±</b> <b>${sale.totals.qty}</b></div>
            <div><span>Toplam tutar</span> <b>${fmtMoney(sale.totals.total)}</b></div>
            <div><span>Endirim</span> <b>${fmtMoney(sale.totals.discount)}</b></div>
            <div><span>√ñd…ônil…ôc…ôk</span> <b>${fmtMoney(sale.totals.finalTotal)}</b></div>
            <div><span>Alƒ±nan m…ôbl…ôq</span> <b>${fmtMoney(sale.totals.paid)}</b></div>
            <div><span>Qaytarƒ±lacaq m…ôbl…ôƒü</span> <b>${fmtMoney(sale.totals.change)}</b></div>
          </div>
          <br/>
          <div class="muted">T…ô≈ü…ôkk√ºrl…ôr!</div>
        </div>
      `;
    }

    function openPrintWindow(html, title="PDF / Q…ôbz"){
      const w = window.open("", "_blank");
      if(!w) return alert("Pop-up bloklanƒ±b. Brauzerd…ô pop-up icaz…ôsi ver.");
      w.document.open();
      w.document.write(`
        <!doctype html>
        <html>
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>${escapeHtml(title)}</title>
            <style>
              body{ font-family: ui-monospace, Menlo, Consolas, monospace; padding:18px; }
              .wrap{ max-width:900px; margin:0 auto; }
              h2{ margin:0 0 8px 0; }
              .muted{ color:#444; font-size:12px; }
              table{ width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
              th,td{ border-bottom:1px solid #ddd; padding:8px; text-align:left; }
              .sum{ margin-top:10px; border-top:2px solid #111; padding-top:10px; }
              .sum div{ display:flex; justify-content:space-between; padding:3px 0; }
              @media print{ button{ display:none !important; } }
              .bar{ display:flex; gap:10px; justify-content:flex-end; margin:0 0 10px 0; }
              button{ padding:10px 12px; border-radius:10px; border:1px solid #ccc; cursor:pointer; }
            </style>
          </head>
          <body>
            <div class="bar">
              <button onclick="window.print()">√áap et / Save as PDF</button>
              <button onclick="window.close()">Baƒüla</button>
            </div>
            <div class="wrap">${html}</div>
          </body>
        </html>
      `);
      w.document.close();
    }

    // -------------------- Reports helpers --------------------
    function filterSalesByRange(fromMs, toMs){
      return state.sales.filter(s => s.createdAt >= fromMs && s.createdAt <= toMs);
    }
    function sumSales(sales){
      let countSales = sales.length;
      let qty = 0;
      let total = 0;
      let discount = 0;
      let finalTotal = 0;

      const productMap = new Map(); // name -> qty
      for(const s of sales){
        qty += Number(s.totals?.qty || 0);
        total += Number(s.totals?.total || 0);
        discount += Number(s.totals?.discount || 0);
        finalTotal += Number(s.totals?.finalTotal || 0);

        for(const it of (s.items||[])){
          const nm = it.name || "???";
          const q = Number(it.count||0);
          productMap.set(nm, (productMap.get(nm)||0) + q);
        }
      }

      // top product
      let topName = "-";
      let topQty = 0;
      for(const [nm, q] of productMap.entries()){
        if(q > topQty){ topQty = q; topName = nm; }
      }

      return { countSales, qty, total, discount, finalTotal, topName, topQty };
    }

    function historyPrintHTML(sales, rangeTitle){
      const rows = sales.map(s=>{
        return `
          <tr>
            <td>${new Date(s.createdAt).toLocaleString("az-AZ")}</td>
            <td>${escapeHtml(s.id)}</td>
            <td>${s.totals.qty}</td>
            <td>${fmtMoney(s.totals.total)}</td>
            <td>${fmtMoney(s.totals.discount)}</td>
            <td>${fmtMoney(s.totals.finalTotal)}</td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="6" class="muted">Satƒ±≈ü yoxdur.</td></tr>`;

      const sum = sumSales(sales);
      return `
        <div class="receipt">
          <h2>Satƒ±≈ü Tarix√ß…ôsi (PDF)</h2>
          <div class="muted">${escapeHtml(rangeTitle)}</div>
          <br/>
          <table>
            <thead>
              <tr>
                <th>Tarix</th>
                <th>Satƒ±≈ü ID</th>
                <th>M…ôhsul sayƒ±</th>
                <th>Toplam</th>
                <th>Endirim</th>
                <th>√ñd…ônil…ôc…ôk</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>

          <div class="sum">
            <div><b>Satƒ±≈ü sayƒ±</b> <b>${sum.countSales}</b></div>
            <div><span>Toplam M…ôhsul</span> <b>${sum.qty}</b></div>
            <div><span>C…ômi Toplam</span> <b>${fmtMoney(sum.total)}</b></div>
            <div><span>C…ômi Endirim</span> <b>${fmtMoney(sum.discount)}</b></div>
            <div><span>C…ômi √ñd…ônil…ôc…ôk</span> <b>${fmtMoney(sum.finalTotal)}</b></div>
            <div><span>Top m…ôhsul</span> <b>${escapeHtml(sum.topName)} (${sum.topQty})</b></div>
          </div>
        </div>
      `;
    }

    // -------------------- Views --------------------
    function render(view){
      const host = $("#viewHost");
      host.innerHTML = "";

      if(view === "ads_list") host.appendChild(viewAdsList());
      else if(view === "ads_new") host.appendChild(viewAdsNew());
      else if(view === "product_new") host.appendChild(viewProductNew());
      else if(view === "products_list") host.appendChild(viewProductsList());
      else if(view === "sales_history") host.appendChild(viewSalesHistory());
      else if(view === "reports") host.appendChild(viewReports());
      else if(view === "settings") host.appendChild(viewSettings());
      else host.appendChild(viewPOS());
    }

    // ---- Ads list
    function viewAdsList(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";
      wrap.innerHTML = `
        <div class="grid2">
          <div class="field">
            <label>Axtar</label>
            <input class="input" id="adsSearch" placeholder="ad v…ô ya link..." />
          </div>
          <div class="field">
            <label>Tez …ôm…ôl</label>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="goAdsNew">Ôºã Yeni reklam sayt</button>
            </div>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Ad</th>
                <th>Link</th>
                <th>Tarix</th>
                <th>∆èm…ôliyyat</th>
              </tr>
            </thead>
            <tbody id="adsTbody"></tbody>
          </table>
        </div>
      `;

      wrap.querySelector("#goAdsNew").addEventListener("click", ()=> go("ads_new"));

      function draw(){
        const q = (wrap.querySelector("#adsSearch").value||"").trim().toLowerCase();
        const rows = state.ads.filter(a=>{
          if(!q) return true;
          return (a.name||"").toLowerCase().includes(q) || (a.link||"").toLowerCase().includes(q);
        });

        const tb = wrap.querySelector("#adsTbody");
        tb.innerHTML = rows.map(a=>`
          <tr>
            <td><b>${escapeHtml(a.name||"")}</b><small>ID: ${escapeHtml(a.id)}</small></td>
            <td>
              <a href="${escapeHtml(a.link||"#")}" target="_blank" rel="noreferrer" style="color: var(--accent2); text-decoration:none;">
                ${escapeHtml(a.link||"")}
              </a>
            </td>
            <td>${new Date(a.createdAt).toLocaleString("az-AZ")}</td>
            <td>
              <div class="rowActions">
                <button class="btn" data-act="edit" data-id="${a.id}">‚úèÔ∏è Redakt…ô</button>
                <button class="btn danger" data-act="del" data-id="${a.id}">üóë Sil</button>
              </div>
            </td>
          </tr>
        `).join("") || `<tr><td colspan="4" class="mini" style="padding:14px;">He√ß n…ô tapƒ±lmadƒ±.</td></tr>`;

        tb.querySelectorAll("button[data-act]").forEach(btn=>{
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          btn.addEventListener("click", ()=>{
            if(act === "del"){
              if(!confirm("Reklam saytƒ± silinsin?")) return;
              adsDelete(id);
              draw(); toast("Silindi");
            }else{
              const a = state.ads.find(x=>x.id===id);
              if(!a) return;
              const name = prompt("Ad (redakt…ô):", a.name || "");
              if(name === null) return;
              const link = prompt("Link (redakt…ô):", a.link || "");
              if(link === null) return;
              adsUpdate(id, {name: name.trim(), link: link.trim()});
              draw(); toast("Redakt…ô olundu");
            }
          });
        });
      }
      wrap.querySelector("#adsSearch").addEventListener("input", draw);
      draw();
      return wrap;
    }

    // ---- Ads new
    function viewAdsNew(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";
      wrap.innerHTML = `
        <div class="grid2">
          <div class="field">
            <label>Reklam sayt adƒ±</label>
            <input class="input" id="adName" placeholder="m…ôs: Instagram Reklam" />
          </div>
          <div class="field">
            <label>Link</label>
            <input class="input" id="adLink" placeholder="m…ôs: https://example.com" />
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ok" id="adSave">‚úÖ Yadda saxla</button>
          <button class="btn" id="adBack">‚¨ÖÔ∏è Siyahƒ±ya qayƒ±t</button>
        </div>
      `;
      wrap.querySelector("#adBack").addEventListener("click", ()=> go("ads_list"));
      wrap.querySelector("#adSave").addEventListener("click", ()=>{
        const name = (wrap.querySelector("#adName").value||"").trim();
        const link = (wrap.querySelector("#adLink").value||"").trim();
        if(!name) return alert("Ad bo≈ü ola bilm…ôz.");
        if(!link) return alert("Link bo≈ü ola bilm…ôz.");
        adsAdd({name, link});
        toast("∆èlav…ô edildi");
        go("ads_list");
      });
      return wrap;
    }

    // ---- Product new
    function viewProductNew(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      wrap.innerHTML = `
        <div class="grid2">
          <div class="field">
            <label>M…ôhsul ≈ü…ôkli (link)</label>
            <input class="input" id="pImage" placeholder="https://.../image.png" />
          </div>
          <div class="field">
            <label>Ad</label>
            <input class="input" id="pName" placeholder="M…ôhsul adƒ±..." />
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Barkod (random LEM-...)</label>
            <div style="display:flex; gap:10px;">
              <input class="input" id="pBarcode" value="${genBarcode()}" />
              <button class="btn" id="regenBarcode">üîÅ</button>
            </div>
          </div>

          <div class="field">
            <label>Axtarƒ±≈ü kodu</label>
            <div style="display:flex; gap:10px; align-items:center;">
              <input class="input" id="pSearch" placeholder="manual: 123456" />
              <button class="btn" id="autoSearch">üé≤ Avto</button>
              <span class="tag">Avto misal: <b id="autoHint">${genSearchCode()}</b></span>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="field"><label>Keyfiyy…ôt</label><select id="pQuality"></select></div>
          <div class="field"><label>M√ºdd…ôt</label><select id="pDuration"></select></div>
        </div>

        <div class="grid2">
          <div class="field"><label>Say (stok)</label><input class="input" id="pQty" type="number" min="0" value="1" /></div>
          <div class="field"><label>Qiym…ôt</label><input class="input" id="pPrice" type="number" min="0" step="0.01" value="0" /></div>
        </div>

        <div class="field">
          <label>Haqqƒ±nda</label>
          <textarea id="pAbout" placeholder="M…ôhsul haqqƒ±nda..."></textarea>
        </div>

        <div class="grid3">
          <div class="field"><label>∆èlaq…ô ‚Ä¢ Telefon</label><input class="input" id="pPhone" placeholder="+994..." /></div>
          <div class="field"><label>∆èlaq…ô ‚Ä¢ Mail</label><input class="input" id="pMail" placeholder="mail@example.com" /></div>
          <div class="field"><label>∆èlaq…ô ‚Ä¢ WhatsApp</label><input class="input" id="pWhats" placeholder="+994..." /></div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ok" id="pSave">‚úÖ M…ôhsulu …ôlav…ô et</button>
          <button class="btn" id="pGoList">üì¶ M…ôhsullara bax</button>
        </div>
      `;

      const qSel = wrap.querySelector("#pQuality");
      const dSel = wrap.querySelector("#pDuration");
      QUALITY.forEach(x=>{ const o=document.createElement("option"); o.value=x; o.textContent=x; qSel.appendChild(o);});
      DURATION.forEach(x=>{ const o=document.createElement("option"); o.value=x; o.textContent=x; dSel.appendChild(o);});

      wrap.querySelector("#regenBarcode").addEventListener("click", ()=>{
        wrap.querySelector("#pBarcode").value = genBarcode();
      });
      wrap.querySelector("#autoSearch").addEventListener("click", ()=>{
        const s = genSearchCode();
        wrap.querySelector("#pSearch").value = s;
        wrap.querySelector("#autoHint").textContent = s;
      });
      wrap.querySelector("#pGoList").addEventListener("click", ()=> go("products_list"));

      wrap.querySelector("#pSave").addEventListener("click", ()=>{
        const name = (wrap.querySelector("#pName").value||"").trim();
        if(!name) return alert("M…ôhsul adƒ± bo≈ü ola bilm…ôz.");
        productAdd({
          image: wrap.querySelector("#pImage").value,
          name,
          barcode: (wrap.querySelector("#pBarcode").value||"").trim() || genBarcode(),
          searchCode: (wrap.querySelector("#pSearch").value||"").trim() || genSearchCode(),
          quality: qSel.value,
          duration: dSel.value,
          qty: wrap.querySelector("#pQty").value,
          price: wrap.querySelector("#pPrice").value,
          about: wrap.querySelector("#pAbout").value,
          phone: wrap.querySelector("#pPhone").value,
          mail: wrap.querySelector("#pMail").value,
          whatsapp: wrap.querySelector("#pWhats").value
        });
        toast("M…ôhsul …ôlav…ô edildi");
        go("products_list");
      });

      return wrap;
    }

    // ---- Products list
    function viewProductsList(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";
      wrap.innerHTML = `
        <div class="grid3">
          <div class="field"><label>Axtar</label><input class="input" id="pSearchQ" placeholder="ad / barkod / axtarƒ±≈ü kodu..." /></div>
          <div class="field"><label>Filter ‚Ä¢ Keyfiyy…ôt</label><select id="fQuality"><option value="">Hamƒ±sƒ±</option></select></div>
          <div class="field"><label>Filter ‚Ä¢ M√ºdd…ôt</label><select id="fDuration"><option value="">Hamƒ±sƒ±</option></select></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="goNewProduct">Ôºã M…ôhsul …ôlav…ô et</button>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>≈û…ôkil</th>
                <th>M…ôhsul</th>
                <th>Keyfiyy…ôt / M√ºdd…ôt</th>
                <th>Stok</th>
                <th>Qiym…ôt</th>
                <th>∆èm…ôliyyat</th>
              </tr>
            </thead>
            <tbody id="pTbody"></tbody>
          </table>
        </div>
      `;

      const qSel = wrap.querySelector("#fQuality");
      const dSel = wrap.querySelector("#fDuration");
      QUALITY.forEach(x=>{ const o=document.createElement("option"); o.value=x; o.textContent=x; qSel.appendChild(o);});
      DURATION.forEach(x=>{ const o=document.createElement("option"); o.value=x; o.textContent=x; dSel.appendChild(o);});

      wrap.querySelector("#goNewProduct").addEventListener("click", ()=> go("product_new"));

      function draw(){
        const q = (wrap.querySelector("#pSearchQ").value||"").trim().toLowerCase();
        const fq = wrap.querySelector("#fQuality").value;
        const fd = wrap.querySelector("#fDuration").value;

        const rows = state.products.filter(p=>{
          if(fq && p.quality !== fq) return false;
          if(fd && p.duration !== fd) return false;
          if(!q) return true;
          return (p.name||"").toLowerCase().includes(q) ||
                 (p.barcode||"").toLowerCase().includes(q) ||
                 (p.searchCode||"").toLowerCase().includes(q);
        });

        const tb = wrap.querySelector("#pTbody");
        tb.innerHTML = rows.map(p=>`
          <tr>
            <td style="width:100px;">
              ${p.image ? `<img src="${escapeHtml(p.image)}" alt="" style="width:80px; height:50px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.12);" />`
                        : `<span class="tag">yoxdur</span>`}
            </td>
            <td>
              <b>${escapeHtml(p.name)}</b>
              <small>Barkod: ${escapeHtml(p.barcode)} ‚Ä¢ Kod: ${escapeHtml(p.searchCode)}</small>
            </td>
            <td>
              <span class="tag">üéû ${escapeHtml(p.quality)}</span>
              <span class="tag">‚è≥ ${escapeHtml(p.duration)}</span>
            </td>
            <td><b>${p.qty}</b></td>
            <td><b>${fmtMoney(p.price)}</b></td>
            <td>
              <div class="rowActions">
                <button class="btn" data-act="edit" data-id="${p.id}">‚úèÔ∏è Redakt…ô</button>
                <button class="btn danger" data-act="del" data-id="${p.id}">üóë Sil</button>
              </div>
            </td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="mini" style="padding:14px;">He√ß n…ô tapƒ±lmadƒ±.</td></tr>`;

        tb.querySelectorAll("button[data-act]").forEach(btn=>{
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          btn.addEventListener("click", ()=>{
            const p = state.products.find(x=>x.id===id);
            if(!p) return;
            if(act === "del"){
              productDelete(id); draw(); toast("Silindi"); return;
            }
            const newName = prompt("Ad:", p.name || "");
            if(newName === null) return;
            const newPrice = prompt("Qiym…ôt:", String(p.price ?? 0));
            if(newPrice === null) return;
            const newQty = prompt("Stok (say):", String(p.qty ?? 0));
            if(newQty === null) return;
            productUpdate(id, { name: newName.trim(), price: Number(newPrice), qty: Number(newQty) });
            draw(); toast("Redakt…ô olundu");
          });
        });
      }

      wrap.querySelector("#pSearchQ").addEventListener("input", draw);
      wrap.querySelector("#fQuality").addEventListener("change", draw);
      wrap.querySelector("#fDuration").addEventListener("change", draw);
      draw();
      return wrap;
    }

    // ---- POS view
    function viewPOS(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";
      wrap.innerHTML = `
        <div class="grid2">
          <div class="field">
            <label>M…ôhsul axtar (ad / barkod / kod)</label>
            <input class="input" id="posSearch" placeholder="m…ôs: Netflix, LEM-..., 123456" />
            <div class="mini">Tapƒ±lanlar a≈üaƒüƒ±da √ßƒ±xacaq. ‚ÄúSe√ß‚úÖ‚Äù ‚Üí say ‚Üí s…ôb…ôt…ô.</div>
          </div>

          <div class="field">
            <label>Se√ßil…ôn m…ôhsul ‚úÖ</label>
            <div id="selectedBox" class="mini">He√ß n…ô se√ßilm…ôyib.</div>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center;">
              <input class="input" id="posCount" type="number" min="1" value="1" style="width:120px;">
              <button class="btn ok" id="addToCart">üß∫ S…ôb…ôt…ô …ôlav…ô et</button>
            </div>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Tapƒ±lan m…ôhsullar</th>
                <th>Qiym…ôt</th>
                <th>Stok</th>
                <th>Se√ß‚úÖ</th>
              </tr>
            </thead>
            <tbody id="posResults"></tbody>
          </table>
        </div>

        <div class="grid2">
          <div class="field">
            <label>S…ôb…ôt</label>
            <div class="tableWrap" style="max-height:220px;">
              <table>
                <thead>
                  <tr>
                    <th>M…ôhsul</th>
                    <th>Say</th>
                    <th>Qiym…ôt</th>
                    <th>Sil</th>
                  </tr>
                </thead>
                <tbody id="cartBody"></tbody>
              </table>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button class="btn danger" id="cartClear">üßπ S…ôb…ôti t…ômizl…ô</button>
            </div>
          </div>

          <div class="field">
            <label>S…ôb…ôti t…ôsdiql…ô</label>
            <div class="mini" id="cartSummary"></div>

            <div class="grid2" style="margin-top:10px;">
              <div class="field">
                <label>Endirim</label>
                <input class="input" id="discountInp" type="number" min="0" step="0.01" value="0">
              </div>
              <div class="field">
                <label>Alƒ±nan m…ôbl…ôq</label>
                <input class="input" id="paidInp" type="number" min="0" step="0.01" value="0">
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button class="btn ok" id="completeSale">‚úÖ Satƒ±≈üƒ± tamamla</button>
              <button class="btn" id="printSale">üñ® √áap et</button>
              <button class="btn" id="pdfSale">üìÑ PDF</button>
            </div>

            <div class="mini" style="margin-top:10px;">
              Qeyd: ‚ÄúSatƒ±≈üƒ± tamamla‚Äù stokdan d√º≈ü√ºr√ºr v…ô satƒ±≈ü tarix√ß…ôsin…ô yazƒ±r.
            </div>
          </div>
        </div>

        <div class="field">
          <label>Son satƒ±≈ülar (son 5)</label>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Tarix</th>
                  <th>M…ôhsul sayƒ±</th>
                  <th>Toplam</th>
                  <th>Endirim</th>
                  <th>√ñd…ônil…ôc…ôk</th>
                  <th>Q…ôbz</th>
                </tr>
              </thead>
              <tbody id="salesBody"></tbody>
            </table>
          </div>
        </div>
      `;

      const selectedBox = wrap.querySelector("#selectedBox");
      const searchInp = wrap.querySelector("#posSearch");
      const resultsTb = wrap.querySelector("#posResults");
      const countInp = wrap.querySelector("#posCount");

      const cartBody = wrap.querySelector("#cartBody");
      const cartSummary = wrap.querySelector("#cartSummary");
      const discountInp = wrap.querySelector("#discountInp");
      const paidInp = wrap.querySelector("#paidInp");
      const salesBody = wrap.querySelector("#salesBody");

      function setSelected(productId){
        cart.selectedProductId = productId;
        const p = state.products.find(x=>x.id===productId);
        if(!p){ selectedBox.textContent = "He√ß n…ô se√ßilm…ôyib."; return; }
        selectedBox.innerHTML = `
          <b>${escapeHtml(p.name)}</b><br/>
          <small>Barkod: ${escapeHtml(p.barcode)} ‚Ä¢ Kod: ${escapeHtml(p.searchCode)}</small><br/>
          <span class="tag">Stok: <b>${p.qty}</b></span>
          <span class="tag">Qiym…ôt: <b>${fmtMoney(p.price)}</b></span>
        `;
      }

      function drawResults(){
        const q = (searchInp.value||"").trim().toLowerCase();
        const rows = q ? findProductByAny(q) : state.products.slice(0, 15);
        resultsTb.innerHTML = rows.map(p=>`
          <tr>
            <td><b>${escapeHtml(p.name)}</b><small>${escapeHtml(p.barcode)} ‚Ä¢ ${escapeHtml(p.searchCode)}</small></td>
            <td><b>${fmtMoney(p.price)}</b></td>
            <td><b>${p.qty}</b></td>
            <td><button class="btn ok" data-sel="${p.id}">Se√ß‚úÖ</button></td>
          </tr>
        `).join("") || `<tr><td colspan="4" class="mini" style="padding:14px;">M…ôhsul yoxdur.</td></tr>`;

        resultsTb.querySelectorAll("button[data-sel]").forEach(b=>{
          b.addEventListener("click", ()=>{ setSelected(b.dataset.sel); toast("Se√ßildi"); });
        });
      }

      function drawCart(){
        const entries = Array.from(cart.items.entries());
        cartBody.innerHTML = entries.map(([pid, count])=>{
          const p = state.products.find(x=>x.id===pid);
          if(!p) return "";
          return `
            <tr>
              <td><b>${escapeHtml(p.name)}</b><small>${escapeHtml(p.barcode)} ‚Ä¢ ${escapeHtml(p.searchCode)}</small></td>
              <td><b>${count}</b></td>
              <td><b>${fmtMoney(p.price)}</b></td>
              <td><button class="btn danger" data-del="${pid}">Sil</button></td>
            </tr>
          `;
        }).join("") || `<tr><td colspan="4" class="mini" style="padding:14px;">S…ôb…ôt bo≈üdur.</td></tr>`;

        cartBody.querySelectorAll("button[data-del]").forEach(b=>{
          b.addEventListener("click", ()=>{ cartRemove(b.dataset.del); drawCart(); drawSummary(); });
        });
      }

      function drawSummary(){
        cart.discount = Number(discountInp.value||0);
        cart.paid = Number(paidInp.value||0);
        const t = cartTotals();
        cartSummary.innerHTML = `
          <div class="tag">Toplam m…ôhsul sayƒ±: <b>${t.totalQty}</b></div>
          <div class="tag">Toplam tutar: <b>${fmtMoney(t.total)}</b></div>
          <div class="tag">Endirim: <b>${fmtMoney(t.discount)}</b></div>
          <div class="tag">√ñd…ônil…ôc…ôk: <b>${fmtMoney(t.finalTotal)}</b></div>
          <div class="tag">Alƒ±nan m…ôbl…ôq: <b>${fmtMoney(t.paid)}</b></div>
          <div class="tag">Qaytarƒ±lacaq: <b>${fmtMoney(t.change)}</b></div>
        `;
      }

      function drawSales(){
        const rows = state.sales.slice(0,5);
        salesBody.innerHTML = rows.map(s=>`
          <tr>
            <td>${new Date(s.createdAt).toLocaleString("az-AZ")}</td>
            <td><b>${s.totals.qty}</b></td>
            <td><b>${fmtMoney(s.totals.total)}</b></td>
            <td><b>${fmtMoney(s.totals.discount)}</b></td>
            <td><b>${fmtMoney(s.totals.finalTotal)}</b></td>
            <td><button class="btn" data-receipt="${s.id}">Q…ôbz</button></td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="mini" style="padding:14px;">Satƒ±≈ü yoxdur.</td></tr>`;

        salesBody.querySelectorAll("button[data-receipt]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const s = state.sales.find(x=>x.id===b.dataset.receipt);
            if(!s) return;
            openPrintWindow(renderReceiptHTML(s), "Q…ôbz");
          });
        });
      }

      wrap.querySelector("#addToCart").addEventListener("click", ()=>{
        const pid = cart.selectedProductId;
        if(!pid) return alert("∆èvv…ôl m…ôhsul se√ß‚úÖ");
        const cnt = clamp(countInp.value, 1, 1000000);
        cartAdd(pid, cnt);
        drawCart(); drawSummary();
      });

      wrap.querySelector("#cartClear").addEventListener("click", ()=>{
        if(!confirm("S…ôb…ôt t…ômizl…ônsin?")) return;
        cart.items.clear();
        drawCart(); drawSummary();
        toast("S…ôb…ôt t…ômizl…ôndi");
      });

      discountInp.addEventListener("input", drawSummary);
      paidInp.addEventListener("input", drawSummary);
      searchInp.addEventListener("input", drawResults);

      function previewCurrentCart(){
        const itemsArr = [];
        for(const [pid, count] of cart.items.entries()){
          const p = state.products.find(x=>x.id===pid);
          if(!p) continue;
          itemsArr.push({ productId: pid, name: p.name, price: Number(p.price)||0, count });
        }
        if(itemsArr.length === 0) return null;
        const t = cartTotals();
        const saleLike = { id:"PREVIEW", createdAt: Date.now(), items: itemsArr, totals: {
          qty: t.totalQty, total: t.total, discount: t.discount, finalTotal: t.finalTotal, paid: t.paid, change: t.change
        }};
        return renderReceiptHTML(saleLike);
      }

      wrap.querySelector("#completeSale").addEventListener("click", ()=>{
        cart.discount = Number(discountInp.value||0);
        cart.paid = Number(paidInp.value||0);

        const t = cartTotals();
        if(t.totalQty <= 0) return alert("S…ôb…ôt bo≈üdur.");
        if(t.paid < t.finalTotal){
          if(!confirm("Alƒ±nan m…ôbl…ôƒü √∂d…ônil…ôc…ôkd…ôn azdƒ±r. Yen…ô d…ô satƒ±≈üƒ± tamamlayƒ±m?")) return;
        }

        const res = cartConfirmAndComplete();
        if(!res) return;

        drawResults(); drawCart(); drawSummary(); drawSales();
        openPrintWindow(res.receiptHtml, "Satƒ±≈ü Q…ôbzi");
      });

      wrap.querySelector("#printSale").addEventListener("click", ()=>{
        cart.discount = Number(discountInp.value||0);
        cart.paid = Number(paidInp.value||0);
        const html = previewCurrentCart();
        if(!html) return alert("S…ôb…ôt bo≈üdur.");
        openPrintWindow(html, "Q…ôbz (Preview)");
      });

      wrap.querySelector("#pdfSale").addEventListener("click", ()=>{
        cart.discount = Number(discountInp.value||0);
        cart.paid = Number(paidInp.value||0);
        const html = previewCurrentCart();
        if(!html) return alert("S…ôb…ôt bo≈üdur.");
        openPrintWindow(html, "PDF (Preview)");
      });

      setSelected(cart.selectedProductId);
      drawResults(); drawCart(); drawSummary(); drawSales();
      return wrap;
    }

    // ---- Sales History (PDF export)
    function viewSalesHistory(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      const today = new Date();
      const iso = formatDateISO(today);

      wrap.innerHTML = `
        <div class="grid2">
          <div class="field">
            <label>Ba≈ülanƒüƒ±c tarix</label>
            <input class="input" id="fromDate" type="date" value="${iso}" />
          </div>
          <div class="field">
            <label>Bitm…ô tarixi</label>
            <input class="input" id="toDate" type="date" value="${iso}" />
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ok" id="pdfAll">üìÑ Se√ßil…ôn aralƒ±ƒüƒ± PDF et</button>
          <button class="btn" id="todayBtn">üìå Bu g√ºn</button>
          <button class="btn" id="monthBtn">üóì Bu ay</button>
        </div>

        <div class="field">
          <label>N…ôtic…ô</label>
          <div class="mini" id="sumBox"></div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Tarix</th>
                <th>Satƒ±≈ü ID</th>
                <th>M…ôhsul sayƒ±</th>
                <th>Toplam</th>
                <th>Endirim</th>
                <th>√ñd…ônil…ôc…ôk</th>
              </tr>
            </thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
      `;

      const fromEl = wrap.querySelector("#fromDate");
      const toEl = wrap.querySelector("#toDate");
      const tb = wrap.querySelector("#tb");
      const sumBox = wrap.querySelector("#sumBox");

      function draw(){
        const from = startOfDay(new Date(fromEl.value));
        const to = endOfDay(new Date(toEl.value));
        const sales = filterSalesByRange(from.getTime(), to.getTime()).slice().sort((a,b)=>b.createdAt-a.createdAt);

        const sum = sumSales(sales);
        sumBox.innerHTML = `
          <div class="tag">Satƒ±≈ü sayƒ±: <b>${sum.countSales}</b></div>
          <div class="tag">Toplam m…ôhsul: <b>${sum.qty}</b></div>
          <div class="tag">C…ômi toplam: <b>${fmtMoney(sum.total)}</b></div>
          <div class="tag">C…ômi endirim: <b>${fmtMoney(sum.discount)}</b></div>
          <div class="tag">C…ômi √∂d…ônil…ôc…ôk: <b>${fmtMoney(sum.finalTotal)}</b></div>
          <div class="tag">Top m…ôhsul: <b>${escapeHtml(sum.topName)} (${sum.topQty})</b></div>
        `;

        tb.innerHTML = sales.map(s=>`
          <tr>
            <td>${new Date(s.createdAt).toLocaleString("az-AZ")}</td>
            <td>${escapeHtml(s.id)}</td>
            <td><b>${s.totals.qty}</b></td>
            <td><b>${fmtMoney(s.totals.total)}</b></td>
            <td><b>${fmtMoney(s.totals.discount)}</b></td>
            <td><b>${fmtMoney(s.totals.finalTotal)}</b></td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="mini" style="padding:14px;">Satƒ±≈ü yoxdur.</td></tr>`;
      }

      wrap.querySelector("#todayBtn").addEventListener("click", ()=>{
        const t = new Date();
        const v = formatDateISO(t);
        fromEl.value = v; toEl.value = v;
        draw();
      });

      wrap.querySelector("#monthBtn").addEventListener("click", ()=>{
        const t = new Date();
        const first = new Date(t.getFullYear(), t.getMonth(), 1);
        const last = new Date(t.getFullYear(), t.getMonth()+1, 0);
        fromEl.value = formatDateISO(first);
        toEl.value = formatDateISO(last);
        draw();
      });

      wrap.querySelector("#pdfAll").addEventListener("click", ()=>{
        const from = startOfDay(new Date(fromEl.value));
        const to = endOfDay(new Date(toEl.value));
        const sales = filterSalesByRange(from.getTime(), to.getTime()).slice().sort((a,b)=>a.createdAt-b.createdAt);

        const title = `Aralƒ±q: ${fromEl.value} ‚Üí ${toEl.value}`;
        const html = historyPrintHTML(sales, title);
        openPrintWindow(html, "Satƒ±≈ü Tarix√ß…ôsi PDF");
      });

      fromEl.addEventListener("change", draw);
      toEl.addEventListener("change", draw);
      draw();
      return wrap;
    }

    // ---- Reports (daily/monthly)
    function viewReports(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      const t = new Date();
      const todayISO = formatDateISO(t);
      const monthFirst = new Date(t.getFullYear(), t.getMonth(), 1);
      const monthLast = new Date(t.getFullYear(), t.getMonth()+1, 0);

      wrap.innerHTML = `
        <div class="grid3">
          <div class="field">
            <label>Rejim</label>
            <select id="mode">
              <option value="day">G√ºnl√ºk</option>
              <option value="month">Aylƒ±q</option>
            </select>
          </div>
          <div class="field" id="dayBox">
            <label>G√ºn se√ß</label>
            <input class="input" id="day" type="date" value="${todayISO}" />
          </div>
          <div class="field" id="monthBox" style="display:none;">
            <label>Ay se√ß</label>
            <input class="input" id="month" type="month" value="${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}" />
          </div>
        </div>

        <div class="cards" id="cards"></div>

        <div class="field">
          <label>Detallar (son satƒ±≈ülar)</label>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Tarix</th>
                  <th>Satƒ±≈ü ID</th>
                  <th>M…ôhsul sayƒ±</th>
                  <th>√ñd…ônil…ôc…ôk</th>
                  <th>Q…ôbz</th>
                </tr>
              </thead>
              <tbody id="tb"></tbody>
            </table>
          </div>
        </div>
      `;

      const mode = wrap.querySelector("#mode");
      const day = wrap.querySelector("#day");
      const month = wrap.querySelector("#month");
      const cards = wrap.querySelector("#cards");
      const tb = wrap.querySelector("#tb");

      function computeRange(){
        if(mode.value === "day"){
          const d = new Date(day.value);
          return { from: startOfDay(d), to: endOfDay(d), title: `G√ºnl√ºk: ${day.value}` };
        }else{
          const [yy, mm] = month.value.split("-").map(Number);
          const f = new Date(yy, mm-1, 1);
          const l = new Date(yy, mm, 0);
          return { from: startOfDay(f), to: endOfDay(l), title: `Aylƒ±q: ${month.value}` };
        }
      }

      function draw(){
        const {from, to, title} = computeRange();
        const sales = filterSalesByRange(from.getTime(), to.getTime()).slice().sort((a,b)=>b.createdAt-a.createdAt);
        const sum = sumSales(sales);

        cards.innerHTML = `
          <div class="card"><div class="k">${escapeHtml(title)}</div><div class="v">${sum.countSales}</div><div class="k">Satƒ±≈ü sayƒ±</div></div>
          <div class="card"><div class="k">Toplam m…ôhsul</div><div class="v">${sum.qty}</div><div class="k">…ôd…ôd</div></div>
          <div class="card"><div class="k">C…ômi endirim</div><div class="v">${fmtMoney(sum.discount)}</div><div class="k">AZN</div></div>
          <div class="card"><div class="k">C…ômi √∂d…ônil…ôc…ôk</div><div class="v">${fmtMoney(sum.finalTotal)}</div><div class="k">AZN</div></div>
          <div class="card" style="grid-column: 1 / -1;">
            <div class="k">∆èn √ßox satƒ±lan</div>
            <div class="v" style="font-size:16px;">${escapeHtml(sum.topName)} <span class="tag">(${sum.topQty} …ôd…ôd)</span></div>
          </div>
        `;

        tb.innerHTML = sales.slice(0, 30).map(s=>`
          <tr>
            <td>${new Date(s.createdAt).toLocaleString("az-AZ")}</td>
            <td>${escapeHtml(s.id)}</td>
            <td><b>${s.totals.qty}</b></td>
            <td><b>${fmtMoney(s.totals.finalTotal)}</b></td>
            <td><button class="btn" data-r="${s.id}">Q…ôbz</button></td>
          </tr>
        `).join("") || `<tr><td colspan="5" class="mini" style="padding:14px;">Satƒ±≈ü yoxdur.</td></tr>`;

        tb.querySelectorAll("button[data-r]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const s = state.sales.find(x=>x.id===b.dataset.r);
            if(!s) return;
            openPrintWindow(renderReceiptHTML(s), "Q…ôbz");
          });
        });
      }

      function syncModeUI(){
        const isDay = mode.value === "day";
        wrap.querySelector("#dayBox").style.display = isDay ? "" : "none";
        wrap.querySelector("#monthBox").style.display = isDay ? "none" : "";
        draw();
      }

      mode.addEventListener("change", syncModeUI);
      day.addEventListener("change", draw);
      month.addEventListener("change", draw);

      syncModeUI();
      return wrap;
    }

    // ---- Settings (change password)
    function viewSettings(){
      const wrap = document.createElement("div");
      wrap.className = "grid1";

      wrap.innerHTML = `
        <div class="hint">
          Buradan admin parolunu d…ôyi≈ü…ô bil…ôrs…ôn.
          <br/>Qeyd: Parol unutsaq, data qalƒ±r, amma parolu sƒ±fƒ±rlamaq √º√ß√ºn ‚ÄúReset‚Äù etm…ôli ola bil…ôrs…ôn.
        </div>

        <div class="grid2">
          <div class="field">
            <label>K√∂hn…ô parol</label>
            <input class="input" id="oldp" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <div class="field">
            <label>Yeni parol</label>
            <input class="input" id="newp" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>

        <div class="field">
          <label>Yeni parol (t…ôkrar)</label>
          <input class="input" id="newp2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ok" id="chg">‚úÖ Parolu d…ôyi≈ü</button>
          <button class="btn" id="locknow">üîí ƒ∞ndi lock et</button>
        </div>
      `;

      wrap.querySelector("#locknow").addEventListener("click", ()=>{
        clearSession();
        requireAuth(true);
      });

      wrap.querySelector("#chg").addEventListener("click", async ()=>{
        const auth = getAuth();
        if(!auth.isSetup) return alert("∆èvv…ôl parol t…ôyin olunmayƒ±b.");
        const oldp = (wrap.querySelector("#oldp").value||"").trim();
        const newp = (wrap.querySelector("#newp").value||"").trim();
        const newp2 = (wrap.querySelector("#newp2").value||"").trim();
        if(newp.length < 4) return alert("Yeni parol …ôn az 4 simvol olsun.");
        if(newp !== newp2) return alert("Yeni parol t…ôkrar il…ô eyni deyil.");

        const oldHash = await sha256(oldp);
        if(oldHash !== auth.passHash) return alert("K√∂hn…ô parol s…ôhvdir.");

        const newHash = await sha256(newp);
        setAuth(newHash);
        setSessionUnlocked(240);
        toast("Parol d…ôyi≈üdi ‚úÖ");
        wrap.querySelector("#oldp").value = "";
        wrap.querySelector("#newp").value = "";
        wrap.querySelector("#newp2").value = "";
      });

      return wrap;
    }

    // -------------------- Init --------------------
    (async ()=>{
      await requireAuth(false);
      if(isUnlocked()){
        go("pos");
      }
    })();
  </script>
</body>
</html>
